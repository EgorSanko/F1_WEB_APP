<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1 Hub</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --f1-red: #E10600;
            --f1-red-dark: #B00500;
            --f1-dark: #15151E;
            --f1-darker: #0F0F15;
            --f1-card: rgba(30,30,44,0.75);
            --f1-card-solid: #1E1E2C;
            --f1-card-hover: #252538;
            --f1-border: rgba(255,255,255,0.06);
            --f1-gray: #38383F;
            --f1-text: #FFFFFF;
            --f1-text-secondary: #9A9AAF;
            --f1-text-muted: #6B6B80;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; -webkit-font-smoothing:antialiased; }
        html, body, #root { height:100dvh; overflow:hidden; }
        body { background:var(--f1-darker); color:var(--f1-text); font-family:'Titillium Web','Segoe UI',system-ui,-apple-system,sans-serif; overflow-x:hidden; }

        ::-webkit-scrollbar { width:3px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:var(--f1-gray); border-radius:4px; }

        .tyre-SOFT { color:#FF3333; } .tyre-MEDIUM { color:#FFD700; } .tyre-HARD { color:#CCCCCC; }
        .tyre-INTERMEDIATE { color:#39B54A; } .tyre-WET { color:#0067FF; } .tyre-UNKNOWN { color:#888; }
        .tyre-dot { width:14px; height:14px; border-radius:50%; border:2px solid currentColor; display:inline-block; }

        .skeleton { background:linear-gradient(90deg,#1e1e2c 25%,#2a2a3e 50%,#1e1e2c 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
        @keyframes shimmer { to { background-position:-200% 0; } }

        .card {
            background:var(--f1-card);
            backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
            border:1px solid var(--f1-border);
            border-radius:16px; padding:16px;
            box-shadow:0 4px 24px rgba(0,0,0,0.2);
            transition:background 0.2s, transform 0.15s;
        }
        .card:active { transform:scale(0.98); }

        .bottom-nav {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(15,15,21,0.92); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
            border-top:1px solid var(--f1-border); z-index:100;
            height:auto; padding:8px 0 calc(8px + env(safe-area-inset-bottom, 12px));
        }
        .nav-item {
            display:flex; flex-direction:column; align-items:center;
            padding:6px 0 4px; font-size:10px; color:var(--f1-text-muted);
            transition:color 0.2s; cursor:pointer; user-select:none;
        }
        .nav-item.active { color:var(--f1-red); }
        .nav-item .nav-icon { width:22px; height:22px; margin-bottom:2px; }

        .btn-primary {
            background:var(--f1-red); color:white; border:none; border-radius:12px;
            padding:12px 24px; font-weight:700; font-size:15px; font-family:inherit;
            cursor:pointer; transition:background 0.2s, transform 0.1s; user-select:none;
        }
        .btn-primary:active { background:var(--f1-red-dark); transform:scale(0.97); }

        .pos-badge {
            width:28px; height:28px; display:flex; align-items:center; justify-content:center;
            border-radius:8px; font-weight:900; font-size:13px; font-variant-numeric:tabular-nums;
        }
        .pos-1 { background:#FFD700; color:#000; } .pos-2 { background:#C0C0C0; color:#000; }
        .pos-3 { background:#CD7F32; color:#000; } .pos-n { background:var(--f1-gray); color:#fff; }

        .live-dot { width:8px; height:8px; background:var(--f1-red); border-radius:50%; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(225,6,0,0.5)} 50%{opacity:0.8;box-shadow:0 0 0 6px rgba(225,6,0,0)} }

        .sector-best { color:#A020F0; font-weight:700; } .sector-pb { color:#39B54A; } .sector-normal { color:var(--f1-text-secondary); }

        .countdown-block { background:var(--f1-card-solid); border-radius:12px; padding:8px 4px; text-align:center; min-width:60px; position:relative; overflow:hidden; }
        .countdown-num { font-size:32px; font-weight:900; font-variant-numeric:tabular-nums; line-height:1; background:linear-gradient(180deg,#fff 0%,#aaa 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .countdown-label { font-size:9px; color:var(--f1-text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

        .fade-in { animation:fadeIn 0.35s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

        .page-container { height:100dvh; padding-bottom:120px !important; overflow-y:auto; -webkit-overflow-scrolling:touch; }

        .standings-row { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid var(--f1-border); transition:background 0.15s; }
        .standings-row:active { background:var(--f1-card-hover); }
        .standings-row:last-child { border-bottom:none; }

        .tab-switch { display:flex; background:var(--f1-card-solid); border-radius:12px; padding:3px; gap:2px; }
        .tab-switch-btn { flex:1; padding:10px 16px; border:none; border-radius:10px; background:transparent; color:var(--f1-text-muted); font-family:inherit; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.2s; }
        .tab-switch-btn.active { background:var(--f1-red); color:white; }

        .live-row {
            display:grid; grid-template-columns:30px 5px 1fr 80px 26px 50px 22px;
            align-items:center; gap:6px; padding:8px 12px;
            border-bottom:1px solid var(--f1-border); font-variant-numeric:tabular-nums;
            transition:background 0.3s; min-height:48px;
        }
        .live-row:active { background:rgba(255,255,255,0.03); }

        .sector-bar { display:flex; gap:2px; height:4px; border-radius:2px; overflow:hidden; }
        .sector-bar > div { flex:1; border-radius:2px; }
        .sb-best { background:#A020F0; } .sb-pb { background:#39B54A; } .sb-normal { background:var(--f1-gray); }

        .sector-time { text-align:center; padding:6px 4px; border-radius:6px; font-size:12px; font-weight:600; font-variant-numeric:tabular-nums; }
        .st-best { background:rgba(160,32,240,0.2); color:#C880FF; }
        .st-pb { background:rgba(57,181,74,0.15); color:#39B54A; }
        .st-normal { background:rgba(255,255,255,0.03); color:var(--f1-text-secondary); }

        .live-tabs { display:flex; gap:0; padding:0 12px; margin-bottom:8px; border-bottom:1px solid var(--f1-border); overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
        .live-tabs::-webkit-scrollbar { display:none; }
        .live-tab { padding:10px 14px; font-size:12px; font-weight:600; font-family:inherit; color:var(--f1-text-muted); background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
        .live-tab.active { color:var(--f1-red); border-bottom-color:var(--f1-red); }

        .flag-icon { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:4px; font-size:10px; font-weight:900; }
        .flag-green{background:#39B54A;color:#fff} .flag-yellow{background:#FFD700;color:#000} .flag-red{background:#E10600;color:#fff} .flag-sc{background:#FF8000;color:#fff} .flag-chequered{background:#fff;color:#000}

        .weather-strip { display:flex; gap:10px; padding:10px 12px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
        .weather-strip::-webkit-scrollbar { display:none; }
        .weather-pill { display:flex; align-items:center; gap:6px; padding:6px 12px; background:var(--f1-card-solid); border-radius:20px; white-space:nowrap; font-size:12px; flex-shrink:0; }
        .weather-pill-val { font-weight:700; }
        .rain-active { background:rgba(0,103,255,0.15); border:1px solid rgba(0,103,255,0.3); }

        .pit-entry { display:flex; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid var(--f1-border); }
        .pit-time { font-size:18px; font-weight:900; font-variant-numeric:tabular-nums; }
        .radio-entry { display:flex; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid var(--f1-border); }
        .radio-play-btn { width:36px; height:36px; border-radius:50%; background:var(--f1-red); border:none; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; font-size:14px; }

        .driver-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; background:var(--f1-gray); flex-shrink:0; }
        .progress-bar-bg { height:4px; background:var(--f1-gray); border-radius:2px; overflow:hidden; }
        .progress-bar-fill { height:100%; border-radius:2px; transition:width 0.5s ease; }

        .news-card { background:var(--f1-card); backdrop-filter:blur(20px); border:1px solid var(--f1-border); border-radius:16px; overflow:hidden; margin-bottom:12px; box-shadow:0 4px 24px rgba(0,0,0,0.2); cursor:pointer; transition:transform 0.15s; }
        .news-card:active { transform:scale(0.98); }
        .news-card-img { width:100%; height:200px; object-fit:cover; }
        .news-card-body { padding:14px 16px; }
        .news-card-title { font-size:15px; font-weight:700; line-height:1.35; margin-bottom:6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .news-card-preview { font-size:13px; color:var(--f1-text-secondary); line-height:1.5; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:10px; }

        .stream-card { width:220px; flex-shrink:0; background:var(--f1-card); border:1px solid var(--f1-border); border-radius:14px; overflow:hidden; cursor:pointer; transition:transform 0.15s; }
        .stream-card:active { transform:scale(0.96); }
        .stream-thumb { width:100%; height:124px; object-fit:cover; background:var(--f1-gray); position:relative; }
        .live-badge { position:absolute; top:8px; left:8px; background:var(--f1-red); color:#fff; font-size:10px; font-weight:900; padding:2px 8px; border-radius:4px; letter-spacing:1px; }

        .gradient-card {
            position:relative; overflow:hidden; border-radius:16px; padding:20px;
            background:var(--f1-card); backdrop-filter:blur(20px);
            border:1px solid var(--f1-border); box-shadow:0 4px 24px rgba(0,0,0,0.2);
        }

        .achievement-badge { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--f1-card-solid); border-radius:12px; border:1px solid var(--f1-border); }
        .achievement-icon { font-size:28px; }
        .achievement-locked { opacity:0.3; filter:grayscale(1); }

        .divider-line { height:1px; background:linear-gradient(90deg,transparent,var(--f1-border),transparent); margin:4px 0; }

        @keyframes flipIn { 0%{transform:rotateX(90deg);opacity:0} 100%{transform:rotateX(0);opacity:1} }
        .flip-anim { animation:flipIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const tg = window.Telegram?.WebApp;
        if (tg) { tg.expand(); tg.setHeaderColor('#0F0F15'); tg.setBackgroundColor('#0F0F15'); }
        const initData = tg?.initData || '';

        // ==== API CLIENT ====
        const api = {
            get: async (url) => {
                try {
                    const res = await fetch(url, { headers: { 'X-Telegram-Init-Data': initData } });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (err) { console.error(`API GET ${url}:`, err); return null; }
            },
            post: async (url, body) => {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (err) { console.error(`API POST ${url}:`, err); return null; }
            }
        };

        // ==== HELPERS ====
        const formatTime = (s) => { if(s==null) return '‚Äî'; const m=Math.floor(s/60); const sec=(s%60).toFixed(3); return m>0?`${m}:${sec.padStart(6,'0')}`:sec; };
        const fmtSector = (v) => v != null ? v.toFixed(3) : '‚Äî';
        const fmtLap = (v) => { if(v==null) return '‚Äî'; const m=Math.floor(v/60); const s=(v%60).toFixed(3); return m>0?`${m}:${s.padStart(6,'0')}`:s; };
        const _downsample = (arr, n=80) => { if(!arr||arr.length<=n) return arr||[]; const s=arr.length/n; return Array.from({length:n},(_,i)=>arr[Math.floor(i*s)]); };

        const formatCountdown = (targetDate) => {
            const now = new Date();
            const target = new Date(targetDate);
            let diff = Math.max(0, Math.floor((target - now) / 1000));
            const days = Math.floor(diff / 86400); diff %= 86400;
            const hours = Math.floor(diff / 3600); diff %= 3600;
            const minutes = Math.floor(diff / 60);
            const secs = diff % 60;
            return { days, hours, minutes, seconds: secs };
        };

        const flagEmoji = (code) => {
            const flags = {'NL':'üá≥üá±','GB':'üá¨üáß','MC':'üá≤üá®','AU':'üá¶üá∫','ES':'üá™üá∏','DE':'üá©üá™','FR':'üá´üá∑','CA':'üá®üá¶','TH':'üáπüá≠','JP':'üáØüáµ','IT':'üáÆüáπ','NZ':'üá≥üáø','BR':'üáßüá∑','AR':'üá¶üá∑',
                'Bahrain':'üáßüá≠','Saudi Arabia':'üá∏üá¶','Australia':'üá¶üá∫','Japan':'üáØüáµ','China':'üá®üá≥','USA':'üá∫üá∏','Italy':'üáÆüáπ','Monaco':'üá≤üá®','Spain':'üá™üá∏','Canada':'üá®üá¶','Austria':'üá¶üáπ','UK':'üá¨üáß','Hungary':'üá≠üá∫','Belgium':'üáßüá™','Netherlands':'üá≥üá±','Azerbaijan':'üá¶üáø','Singapore':'üá∏üá¨','Mexico':'üá≤üáΩ','Brazil':'üáßüá∑','Qatar':'üá∂üá¶','UAE':'üá¶üá™'};
            return flags[code] || 'üè≥Ô∏è';
        };

        const openLink = (url) => { if (tg?.openLink) tg.openLink(url, {try_instant_view: false}); else window.open(url, '_blank'); };

        // ==== SVG NAV ICONS ====
        const NavIcons = {
            home: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            live: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 010 8.49m-8.48-.01a6 6 0 010-8.49m11.31-2.82a10 10 0 010 14.14m-14.14 0a10 10 0 010-14.14"/></svg>,
            news: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg>,
            calendar: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            trophy: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 010-5H6"/><path d="M18 9h1.5a2.5 2.5 0 000-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0012 0V2z"/></svg>,
            predict: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>,
            user: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            analytics: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
        };

        // ==== SKELETON ====
        const Skeleton = ({w='100%',h='16px',r='8px',className=''}) => <div className={`skeleton ${className}`} style={{width:w,height:h,borderRadius:r}}/>;
        const CardSkeleton = () => <div className="card" style={{display:'flex',flexDirection:'column',gap:12}}><Skeleton w="60%" h="20px"/><Skeleton w="100%" h="14px"/><Skeleton w="80%" h="14px"/></div>;

        // ==== BOTTOM NAV ====
        const BottomNav = ({active, onChange, isLive}) => {
            const tabs = [
                {id:'home', icon:NavIcons.home, label:'–ì–ª–∞–≤–Ω–∞—è'},
                {id:'live', icon:NavIcons.live, label:'–û–Ω–ª–∞–π–Ω'},
                {id:'news', icon:NavIcons.news, label:'–ù–æ–≤–æ—Å—Ç–∏'},
                {id:'standings', icon:NavIcons.trophy, label:'–ß–µ–º–ø–∏–æ–Ω–∞—Ç'},
                {id:'predict', icon:NavIcons.predict, label:'–ü—Ä–æ–≥–Ω–æ–∑—ã'},
                {id:'profile', icon:NavIcons.user, label:'–ü—Ä–æ—Ñ–∏–ª—å'},
            ];
            return (
                <div className="bottom-nav">
                    <div style={{display:'flex',justifyContent:'space-around',maxWidth:500,margin:'0 auto'}}>
                        {tabs.map(tab => (
                            <div key={tab.id} className={`nav-item ${active===tab.id?'active':''}`} onClick={()=>onChange(tab.id)}>
                                <span className="nav-icon" style={{position:'relative'}}>
                                    {tab.icon}
                                    {tab.id==='live' && isLive && <span className="live-dot" style={{position:'absolute',top:-2,right:-6}}/>}
                                </span>
                                <span>{tab.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==== COUNTDOWN ====
        const Countdown = ({targetDate}) => {
            const [time, setTime] = useState(formatCountdown(targetDate));
            const [prevSec, setPrevSec] = useState(-1);
            useEffect(() => {
                const iv = setInterval(() => { const t = formatCountdown(targetDate); setPrevSec(time.seconds); setTime(t); }, 1000);
                return () => clearInterval(iv);
            }, [targetDate, time.seconds]);
            return (
                <div style={{display:'flex',gap:8,justifyContent:'center'}}>
                    {[{val:time.days,label:'–¥–Ω–µ–π'},{val:time.hours,label:'—á–∞—Å–æ–≤'},{val:time.minutes,label:'–º–∏–Ω—É—Ç'},{val:time.seconds,label:'—Å–µ–∫—É–Ω–¥'}].map((item,i)=>(
                        <div key={i} className="countdown-block">
                            <div className={`countdown-num ${i===3?'flip-anim':''}`} key={i===3?item.val:'s'}>{String(item.val).padStart(2,'0')}</div>
                            <div className="countdown-label">{item.label}</div>
                        </div>
                    ))}
                </div>
            );
        };

        const PosBadge = ({pos}) => <div className={`pos-badge ${pos<=3?`pos-${pos}`:'pos-n'}`}>{pos}</div>;
        const TyreIcon = ({compound}) => <span className={`tyre-dot tyre-${compound||'UNKNOWN'}`} title={compound}/>;
        const SectorBar = ({s1,s2,s3}) => <div className="sector-bar"><div className={`sb-${s1||'normal'}`}/><div className={`sb-${s2||'normal'}`}/><div className={`sb-${s3||'normal'}`}/></div>;
        const FlagIcon = ({flag}) => {
            const map = {'GREEN':{cls:'flag-green',text:'G'},'YELLOW':{cls:'flag-yellow',text:'!'},'DOUBLE YELLOW':{cls:'flag-yellow',text:'!!'},'RED':{cls:'flag-red',text:'R'},'CHEQUERED':{cls:'flag-chequered',text:'üèÅ'}};
            const f = map[flag]||{cls:'',text:'‚Ä¢'};
            return <span className={`flag-icon ${f.cls}`}>{f.text}</span>;
        };

        const DriverPhoto = ({url, size=32, style:s={}}) => (
            <img src={url} alt="" className="driver-avatar"
                 style={{width:size,height:size,...s}}
                 onError={e=>{e.target.style.display='none'}}
                 loading="lazy"/>
        );

        // ==== HOME PAGE ====
        const HomePage = ({nextRace, lastRace, standings, user, streams, seasonResults, onChange, season, onSeasonChange, spoilerFree}) => {
            if (!nextRace && !lastRace) return (
                <div className="page-container fade-in" style={{padding:16}}>
                    <div style={{textAlign:'center',padding:'8px 0'}}>
                        <div style={{fontSize:12,color:'var(--f1-text-muted)',letterSpacing:3,textTransform:'uppercase'}}>Formula 1 ¬∑ {season}</div>
                        <h1 style={{fontSize:26,fontWeight:900,margin:'4px 0'}}>F1 <span style={{color:'var(--f1-red)'}}>Hub</span></h1>
                        <div style={{display:'flex',gap:4,justifyContent:'center',marginTop:8}}>
                            {[2025,2026].map(y=><button key={y} onClick={()=>onSeasonChange(y)} style={{background:season===y?'var(--f1-red)':'rgba(255,255,255,0.06)',border:'1px solid '+(season===y?'var(--f1-red)':'var(--f1-border)'),borderRadius:8,padding:'6px 16px',color:season===y?'white':'var(--f1-text-muted)',fontSize:13,fontWeight:700,cursor:'pointer',fontFamily:'inherit',transition:'all 0.2s'}}>{y}</button>)}
                        </div>
                    </div>
                    <CardSkeleton/><div style={{height:16}}/><CardSkeleton/>
                </div>
            );
            return (
                <div className="page-container fade-in" style={{padding:16,display:'flex',flexDirection:'column',gap:16}}>
                    <div style={{textAlign:'center',padding:'8px 0'}}>
                        <div style={{fontSize:12,color:'var(--f1-text-muted)',letterSpacing:3,textTransform:'uppercase'}}>Formula 1 ¬∑ {season}</div>
                        <h1 style={{fontSize:26,fontWeight:900,margin:'4px 0'}}>F1 <span style={{color:'var(--f1-red)'}}>Hub</span></h1>
                        <div style={{display:'flex',gap:4,justifyContent:'center',marginTop:8}}>
                            {[2025,2026].map(y=><button key={y} onClick={()=>onSeasonChange(y)} style={{background:season===y?'var(--f1-red)':'rgba(255,255,255,0.06)',border:'1px solid '+(season===y?'var(--f1-red)':'var(--f1-border)'),borderRadius:8,padding:'6px 16px',color:season===y?'white':'var(--f1-text-muted)',fontSize:13,fontWeight:700,cursor:'pointer',fontFamily:'inherit',transition:'all 0.2s'}}>{y}</button>)}
                        </div>
                    </div>

                    {nextRace && nextRace.name && (
                        <div className="gradient-card" style={{minHeight:200}}>
                            {nextRace.circuit_image && <img src={nextRace.circuit_image} alt="" style={{position:'absolute',top:0,right:0,width:'55%',height:'100%',objectFit:'contain',opacity:0.08,pointerEvents:'none'}}/>}
                            <div style={{position:'absolute',top:0,left:0,right:0,bottom:0,background:'linear-gradient(135deg,rgba(225,6,0,0.15) 0%,transparent 60%)',pointerEvents:'none',borderRadius:16}}/>
                            <div style={{position:'relative',zIndex:1}}>
                                <div style={{fontSize:11,color:'var(--f1-red)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>
                                    üèÅ –°–ª–µ–¥—É—é—â–∏–π –≥—Ä–∞–Ω-–ø—Ä–∏
                                </div>
                                <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
                                    <span style={{fontSize:32}}>{flagEmoji(nextRace.country)}</span>
                                    <div>
                                        <div style={{fontSize:20,fontWeight:900}}>{nextRace.name}</div>
                                        <div style={{fontSize:13,color:'var(--f1-text-secondary)'}}>{nextRace.circuit} ¬∑ –†–∞—É–Ω–¥ {nextRace.round}</div>
                                    </div>
                                </div>
                                {nextRace.race_datetime && <div style={{marginTop:16}}><Countdown targetDate={nextRace.race_datetime}/></div>}
                                {nextRace.sessions && (
                                    <div style={{marginTop:16,display:'flex',flexWrap:'wrap',gap:6}}>
                                        {Object.entries(nextRace.sessions).map(([key,val])=>{
                                            const names = {fp1:'FP1',fp2:'FP2',fp3:'FP3',qualifying:'–ö–í–ê–õ–ò',race:'–ì–û–ù–ö–ê',sprint:'–°–ü–†–ò–ù–¢',sprint_qualifying:'–°–ö'};
                                            return (
                                                <div key={key} style={{background:key==='race'?'var(--f1-red)':'rgba(255,255,255,0.05)',borderRadius:8,padding:'6px 10px',fontSize:11,fontWeight:600}}>
                                                    <div style={{opacity:0.7}}>{names[key]||key}</div>
                                                    <div>{val.date?.slice(5)} {val.time?.slice(0,5)}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* VK Race Recordings ‚Äî last 3 races */}
                    {seasonResults?.races && (() => {
                        const now = new Date();
                        const pastRaces = seasonResults.races.filter(r => new Date(r.date) < now && (r.vk_url || r.vk_search_url)).slice(-3).reverse();
                        if (!pastRaces.length) return null;
                        return (
                            <div>
                                <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10,paddingLeft:4}}>
                                    üì∫ –ó–∞–ø–∏—Å–∏ –≥–æ–Ω–æ–∫
                                </div>
                                <div style={{display:'flex',gap:10,overflowX:'auto',paddingBottom:10,scrollbarWidth:'none',WebkitOverflowScrolling:'touch'}}>
                                    {pastRaces.map((race, ri) => {
                                        const flag = countryFlag(race.country_code) || circuitFlags[race.circuit_id] || 'üèÅ';
                                        const isLastRace = spoilerFree && ri === 0;
                                        return (
                                            <div key={race.round} className="stream-card" onClick={()=>openLink(race.vk_url || race.vk_search_url)} style={{minWidth:200}}>
                                                <div style={{width:'100%',height:124,background:`linear-gradient(135deg,${isLastRace?'var(--f1-red)':race.winner?.team_color||'var(--f1-red)'}33,var(--f1-card-solid))`,position:'relative',overflow:'hidden',display:'flex',alignItems:'center',justifyContent:'center'}}>
                                                    {isLastRace ? <div style={{fontSize:36}}>üîí</div> : race.winner?.photo_url && <img src={race.winner.photo_url} alt="" style={{width:64,height:64,borderRadius:'50%',objectFit:'cover',border:`3px solid ${race.winner.team_color||'#FFD700'}`,background:'var(--f1-gray)'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                    <div style={{position:'absolute',top:8,left:8,fontSize:20}}>{flag}</div>
                                                    <div style={{position:'absolute',top:8,right:8,background:'rgba(0,119,255,0.9)',color:'#fff',fontSize:9,fontWeight:900,padding:'2px 6px',borderRadius:4}}>VK</div>
                                                </div>
                                                <div style={{padding:'10px 12px'}}>
                                                    <div style={{fontSize:13,fontWeight:600,lineHeight:1.3,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{race.name}</div>
                                                    <div style={{fontSize:11,color:'var(--f1-text-muted)',marginTop:2,display:'flex',alignItems:'center',gap:4}}>
                                                        {isLastRace ? <span style={{color:'var(--f1-red)',fontWeight:700}}>üîí –ë–µ–∑ —Å–ø–æ–π–ª–µ—Ä–æ–≤</span> : <span style={{color:'#FFD700',fontWeight:700}}>üèÜ {race.winner?.code}</span>}
                                                        <span>¬∑ R{race.round}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    <div className="stream-card" onClick={()=>onChange('schedule')} style={{display:'flex',alignItems:'center',justifyContent:'center',minWidth:120,minHeight:160}}>
                                        <div style={{textAlign:'center',padding:20}}>
                                            <div style={{fontSize:28,marginBottom:8}}>üìÖ</div>
                                            <div style={{fontSize:12,fontWeight:600,color:'var(--f1-text-secondary)'}}>–í—Å–µ –≥–æ–Ω–∫–∏</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Last race ‚Äî podium layout */}
                    {lastRace && lastRace.results && (
                        <div className="card" style={{padding:'16px 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:14}}>üèÅ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ¬∑ {lastRace.name?.replace('Grand Prix','–ì–ü')}</div>
                            {/* Podium ‚Äî positions 2, 1, 3 */}
                            <div style={{display:'flex',justifyContent:'center',alignItems:'flex-end',gap:8,marginBottom:16}}>
                                {[1,0,2].map(idx => {
                                    const r = lastRace.results[idx]; if(!r) return null;
                                    const heights = [120,90,80]; const photoSizes = [56,44,44];
                                    const colors = ['#FFD700','#C0C0C0','#CD7F32'];
                                    return (
                                        <div key={idx} style={{flex:1,maxWidth:110,textAlign:'center'}}>
                                            <div style={{position:'relative',marginBottom:6}}>
                                                {r.photo_url && <img src={r.photo_url} alt="" style={{width:photoSizes[idx],height:photoSizes[idx],borderRadius:'50%',objectFit:'cover',border:`3px solid ${colors[idx]}`,background:'var(--f1-gray)',margin:'0 auto'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                            </div>
                                            <div style={{fontWeight:900,fontSize:idx===0?15:13}}>{r.code || r.name?.split(' ').pop()}</div>
                                            <div style={{fontSize:10,color:'var(--f1-text-muted)'}}>{r.team?.split(' ')[0]}</div>
                                            <div style={{background:`${colors[idx]}22`,borderRadius:'8px 8px 0 0',padding:'10px 0',marginTop:6,height:heights[idx],display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-start',paddingTop:10}}>
                                                <div style={{fontSize:24,fontWeight:900,color:colors[idx]}}>{r.position}</div>
                                                <div style={{fontSize:10,color:'var(--f1-text-muted)',marginTop:2}}>{r.time||`${r.points} –æ—á–∫.`}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            {/* Rest of results */}
                            {lastRace.results.slice(3,8).map((r,i)=>(
                                <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'7px 0',borderBottom:i<4?'1px solid var(--f1-border)':'none'}}>
                                    <div style={{width:24,fontWeight:700,fontSize:13,color:'var(--f1-text-muted)',textAlign:'center'}}>{r.position}</div>
                                    <div style={{background:r.team_color,width:3,height:28,borderRadius:2}}/>
                                    {r.photo_url && <DriverPhoto url={r.photo_url} size={24}/>}
                                    <div style={{flex:1,minWidth:0}}>
                                        <span style={{fontWeight:700,fontSize:13}}>{r.code || r.name?.split(' ').pop()}</span>
                                        <span style={{fontSize:11,color:'var(--f1-text-muted)',marginLeft:6}}>{r.team?.split(' ')[0]}</span>
                                    </div>
                                    <div style={{fontWeight:600,fontSize:12,color:'var(--f1-text-secondary)',fontVariantNumeric:'tabular-nums'}}>{r.time||''}</div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Championship top-3 ‚Äî bigger photos */}
                    {standings?.not_started && (
                        <div className="card" style={{padding:'20px 16px',textAlign:'center'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:12}}>üèÜ –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø–∏–ª–æ—Ç–æ–≤</div>
                            <div style={{fontSize:32,marginBottom:8}}>üèÅ</div>
                            <div style={{fontSize:15,fontWeight:700,marginBottom:4}}>–°–µ–∑–æ–Ω {season} –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è</div>
                            <div style={{fontSize:13,color:'var(--f1-text-secondary)'}}>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–æ–Ω–∫–∏</div>
                        </div>
                    )}
                    {standings?.standings && (
                        <div className="card" style={{padding:'16px 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:12}}>üèÜ –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø–∏–ª–æ—Ç–æ–≤</div>
                            {standings.standings.slice(0,3).map((s,i)=>(
                                <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 0',borderBottom:i<2?'1px solid var(--f1-border)':'none'}}>
                                    <div style={{fontSize:20,fontWeight:900,color:['#FFD700','#C0C0C0','#CD7F32'][i],minWidth:24,textAlign:'center'}}>{s.position}</div>
                                    {s.photo_url && <img src={s.photo_url} alt="" style={{width:48,height:48,borderRadius:'50%',objectFit:'cover',background:'var(--f1-gray)',border:`3px solid ${s.team_color}`,flexShrink:0}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                    <div style={{flex:1,minWidth:0}}>
                                        <div style={{fontWeight:900,fontSize:15}}>{s.name}</div>
                                        <div style={{fontSize:11,color:s.team_color,fontWeight:600}}>{s.team}</div>
                                    </div>
                                    <div style={{textAlign:'right'}}>
                                        <div style={{fontWeight:900,fontSize:18,fontVariantNumeric:'tabular-nums'}}>{s.points}</div>
                                        <div style={{fontSize:9,color:'var(--f1-text-muted)'}}>–æ—á–∫–æ–≤</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                        <div className="gradient-card" onClick={()=>onChange('predict')} style={{textAlign:'center',cursor:'pointer',padding:'20px 16px',background:'linear-gradient(135deg,rgba(225,6,0,0.12),var(--f1-card))'}}>
                            <div style={{fontSize:32}}>&#x1F52E;</div>
                            <div style={{fontSize:14,fontWeight:700,marginTop:6}}>–ü—Ä–æ–≥–Ω–æ–∑—ã</div>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>–£–≥–∞–¥–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                        </div>
                        <div className="gradient-card" onClick={()=>onChange('schedule')} style={{textAlign:'center',cursor:'pointer',padding:'20px 16px',background:'linear-gradient(135deg,rgba(102,146,255,0.12),var(--f1-card))'}}>
                            <div style={{fontSize:32}}>üìÖ</div>
                            <div style={{fontSize:14,fontWeight:700,marginTop:6}}>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>–í—Å–µ –≥—Ä–∞–Ω-–ø—Ä–∏</div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==== LIVE PAGE ====
        const DemoBanner = ({session, onPickSession}) => {
            if (!session?.is_demo) return null;
            const demoInfo = session.demo_session;
            return (
                <div style={{margin:'0 12px 8px',padding:'8px 12px',borderRadius:10,background:'linear-gradient(135deg,rgba(255,165,0,0.15),rgba(255,200,0,0.08))',border:'1px solid rgba(255,165,0,0.3)',display:'flex',alignItems:'center',gap:8,fontSize:12}}>
                    <span style={{fontSize:16}}>{'üì∫'}</span>
                    <div style={{flex:1}}>
                        <div style={{fontWeight:700,color:'#FFA500'}}>–î–µ–º–æ-—Ä–µ–∂–∏–º</div>
                        <div style={{color:'var(--f1-text-secondary)',fontSize:11}}>{demoInfo?.meeting_name || session.meeting_name || '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å–µ—Å—Å–∏—è'}</div>
                    </div>
                    <button onClick={onPickSession} style={{background:'rgba(255,165,0,0.2)',border:'1px solid rgba(255,165,0,0.4)',borderRadius:8,padding:'4px 10px',color:'#FFA500',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit',whiteSpace:'nowrap'}}>–í—ã–±—Ä–∞—Ç—å</button>
                </div>
            );
        };

        const DemoSessionPicker = ({show, onClose, onSelect}) => {
            const [sessions, setSessions] = useState(null);
            useEffect(() => {
                if (show && !sessions) api.get('/api/demo/sessions').then(d => { if (d) setSessions(d.sessions); });
            }, [show]);
            if (!show) return null;
            return (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:9999,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'flex-end',justifyContent:'center'}} onClick={onClose}>
                    <div style={{width:'100%',maxWidth:480,maxHeight:'70vh',background:'var(--f1-card-solid)',borderRadius:'20px 20px 0 0',padding:'16px',overflow:'auto'}} onClick={e=>e.stopPropagation()}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                            <h3 style={{fontSize:16,fontWeight:900}}>–í—ã–±—Ä–∞—Ç—å —Å–µ—Å—Å–∏—é</h3>
                            <button onClick={async()=>{await api.get('/api/demo/clear');onClose();window.location.reload();}} style={{background:'rgba(255,255,255,0.06)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'4px 10px',color:'var(--f1-text-secondary)',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>–ê–≤—Ç–æ</button>
                        </div>
                        {!sessions ? <div className="skeleton" style={{height:200}}/> : sessions.map(s => (
                            <div key={s.session_key} onClick={async()=>{await api.get('/api/demo/set?session_key='+s.session_key);onSelect(s);onClose();window.location.reload();}} style={{padding:'10px 12px',borderRadius:10,marginBottom:6,background:'rgba(255,255,255,0.04)',border:'1px solid var(--f1-border)',cursor:'pointer',display:'flex',alignItems:'center',gap:10}}>
                                <div style={{width:28,height:28,borderRadius:'50%',background:'rgba(255,165,0,0.15)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,fontWeight:700,color:'#FFA500'}}>R{s.round}</div>
                                <div style={{flex:1}}>
                                    <div style={{fontSize:13,fontWeight:700}}>{s.name}</div>
                                    <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{s.date} ¬∑ {s.laps} –∫—Ä—É–≥–æ–≤</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const LivePage = ({session, positions, timing, weather, raceControl, onChange}) => {
            const [liveTab, setLiveTab] = useState('positions');
            const [expandedRow, setExpandedRow] = useState(null);
            const [radioData, setRadioData] = useState(null);
            const [pitData, setPitData] = useState(null);
            const [audioPlaying, setAudioPlaying] = useState(null);
            const [trackMapData, setTrackMapData] = useState(null);
            const [selectedCar, setSelectedCar] = useState(null);
            const [showDemoPicker, setShowDemoPicker] = useState(false);
            const [transcripts, setTranscripts] = useState({});
            const [transcribing, setTranscribing] = useState({});
            const audioRef = useRef(null);

            const handleTranscribe = async (audioUrl) => {
                if (transcripts[audioUrl] || transcribing[audioUrl]) return;
                setTranscribing(p => ({...p, [audioUrl]: true}));
                try {
                    const data = await api.get(`/api/radio/transcribe?url=${encodeURIComponent(audioUrl)}`);
                    if (data) setTranscripts(p => ({...p, [audioUrl]: data}));
                } catch(e) {
                    setTranscripts(p => ({...p, [audioUrl]: {error: '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏'}}));
                }
                setTranscribing(p => ({...p, [audioUrl]: false}));
            };
            const isLive = session?.is_live;

            useEffect(() => {
                if (liveTab === 'pits' && !pitData) api.get('/api/live/pit-stops').then(setPitData);
            }, [liveTab]);

            // Radio polling (15s live, 30s demo)
            useEffect(() => {
                if (liveTab !== 'radio') return;
                const fetchRadio = () => api.get('/api/live/radio').then(d => { if (d) setRadioData(d); });
                fetchRadio();
                const iv = setInterval(fetchRadio, session?.is_demo ? 30000 : 15000);
                return () => clearInterval(iv);
            }, [liveTab, session?.is_demo]);

            // Track map polling (1.5s live, 30s demo ‚Äî data is cached anyway)
            useEffect(() => {
                if (liveTab !== 'track') return;
                const fetchTrack = () => api.get('/api/live/track-map').then(d => { if (d) setTrackMapData(d); });
                fetchTrack();
                const iv = setInterval(fetchTrack, session?.is_demo ? 30000 : 1500);
                return () => clearInterval(iv);
            }, [liveTab, session?.is_demo]);

            const playRadio = (url) => {
                if (audioRef.current) audioRef.current.pause();
                if (audioPlaying === url) { setAudioPlaying(null); return; }
                const audio = new Audio(url); audioRef.current = audio;
                audio.play().catch(()=>{}); audio.onended = () => setAudioPlaying(null); setAudioPlaying(url);
            };
            useEffect(() => () => { if (audioRef.current) audioRef.current.pause(); }, []);

            if (!session) return <div className="page-container fade-in" style={{padding:16}}><CardSkeleton/><div style={{height:12}}/><CardSkeleton/></div>;

            const timingMap = {};
            if (timing?.timing) timing.timing.forEach(t => { timingMap[t.driver_number] = t; });

            return (
                <div className="page-container fade-in" style={{padding:0}}>
                    <div style={{padding:'10px 16px 0',position:'relative'}}>
                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:2}}>
                            {isLive && <span className="live-dot"/>}
                            <span style={{fontSize:11,fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,color:isLive?'var(--f1-red)':session?.is_demo?'#FFA500':'var(--f1-text-muted)'}}>{isLive?'LIVE':session?.is_demo?'–î–ï–ú–û':'–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è'}</span>
                            {timing?.session_best?.lap && <span style={{fontSize:11,color:'#A020F0',fontWeight:700,marginLeft:'auto'}}>–õ—É—á—à–∏–π: {fmtLap(timing.session_best.lap)}</span>}
                        </div>
                        <h2 style={{fontSize:18,fontWeight:900,lineHeight:1.2}}>{session.meeting_name || '–ì—Ä–∞–Ω-–ø—Ä–∏'}</h2>
                        <div style={{fontSize:12,color:'var(--f1-text-secondary)',marginBottom:4}}>{session.session_name || session.session_type || ''} ¬∑ {session.circuit_short_name}</div>
                        {onChange && <button onClick={()=>onChange('analytics')} style={{position:'absolute',top:10,right:16,background:'rgba(255,255,255,0.06)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'5px 10px',color:'var(--f1-text-secondary)',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit',display:'flex',alignItems:'center',gap:4}}>
                            <span style={{width:14,height:14,display:'inline-flex'}}>{NavIcons.analytics}</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                        </button>}
                    </div>

                    <DemoBanner session={session} onPickSession={()=>setShowDemoPicker(true)}/>
                    <DemoSessionPicker show={showDemoPicker} onClose={()=>setShowDemoPicker(false)} onSelect={()=>{}}/>

                    {weather?.weather && (
                        <div className="weather-strip">
                            <div className={`weather-pill ${weather.weather.is_raining?'rain-active':''}`}><span style={{fontSize:14}}>{weather.weather.is_raining?'üåßÔ∏è':'‚òÄÔ∏è'}</span><span className="weather-pill-val">{weather.weather.air_temperature||'‚Äî'}¬∞C</span></div>
                            <div className="weather-pill"><span style={{fontSize:14}}>üèÅ</span><span>–¢—Ä–∞—Å—Å–∞ </span><span className="weather-pill-val">{weather.weather.track_temperature||'‚Äî'}¬∞C</span></div>
                            <div className="weather-pill"><span style={{fontSize:14}}>üíß</span><span className="weather-pill-val">{weather.weather.humidity||'‚Äî'}%</span></div>
                            <div className="weather-pill"><span style={{fontSize:14}}>üí®</span><span className="weather-pill-val">{weather.weather.wind_speed||'‚Äî'} –º/—Å</span></div>
                        </div>
                    )}

                    {raceControl?.messages?.length > 0 && (() => {
                        const last = raceControl.messages[raceControl.messages.length-1];
                        const isFlag = last.flag==='RED'||last.flag==='YELLOW'||last.flag==='DOUBLE YELLOW';
                        if (!isFlag && last.category !== 'SafetyCar') return null;
                        return (
                            <div style={{margin:'4px 12px 8px',padding:'8px 12px',borderRadius:10,display:'flex',alignItems:'center',gap:8,fontSize:12,fontWeight:600,
                                background:last.flag==='RED'?'rgba(225,6,0,0.2)':last.flag==='YELLOW'||last.flag==='DOUBLE YELLOW'?'rgba(255,215,0,0.12)':'rgba(255,128,0,0.12)',
                                border:`1px solid ${last.flag==='RED'?'rgba(225,6,0,0.4)':last.flag==='YELLOW'||last.flag==='DOUBLE YELLOW'?'rgba(255,215,0,0.3)':'rgba(255,128,0,0.3)'}`,
                                animation:'fadeIn 0.3s ease-out'}}>
                                <FlagIcon flag={last.flag||'YELLOW'}/><span style={{flex:1}}>{last.message}</span>
                                {last.lap_number && <span style={{color:'var(--f1-text-muted)'}}>L{last.lap_number}</span>}
                            </div>
                        );
                    })()}

                    <div className="live-tabs">
                        {[{id:'positions',label:'–ü–æ–∑–∏—Ü–∏–∏'},{id:'track',label:'–¢—Ä–∞—Å—Å–∞'},{id:'sectors',label:'–°–µ–∫—Ç–æ—Ä—ã'},{id:'pits',label:'–ü–∏—Ç-—Å—Ç–æ–ø—ã'},{id:'radio',label:'–†–∞–¥–∏–æ'},{id:'messages',label:'–î–∏—Ä–µ–∫—Ü–∏—è'}].map(t=>(
                            <button key={t.id} className={`live-tab ${liveTab===t.id?'active':''}`} onClick={()=>setLiveTab(t.id)}>{t.label}</button>
                        ))}
                    </div>

                    {liveTab==='positions' && (positions?.positions?.length>0 ? (
                        <div>
                            <div className="live-row" style={{fontSize:10,color:'var(--f1-text-muted)',fontWeight:600,textTransform:'uppercase',letterSpacing:0.5,minHeight:28,padding:'4px 12px'}}>
                                <span>P</span><span></span><span>–ü–∏–ª–æ—Ç</span><span style={{textAlign:'center'}}>–í—Ä–µ–º—è</span><span style={{textAlign:'center'}}>–®</span><span style={{textAlign:'right'}}>–û—Ç—Å—Ç.</span><span style={{textAlign:'center'}}>üîß</span>
                            </div>
                            {positions.positions.map((p,i) => {
                                const t = timingMap[p.driver_number]; const isExp = expandedRow===p.driver_number;
                                return (
                                    <div key={p.driver_number}>
                                        <div className={`live-row ${isExp?'live-row-expanded':''}`} onClick={()=>setExpandedRow(isExp?null:p.driver_number)}
                                             style={{background:i%2===0?'transparent':`${p.team_color}08`,cursor:'pointer'}}>
                                            <PosBadge pos={p.position}/>
                                            <div style={{background:p.team_color,width:5,height:34,borderRadius:2,alignSelf:'center'}}/>
                                            <div style={{minWidth:0}}><div style={{fontWeight:700,fontSize:14,lineHeight:1.2}}>{p.code||p.name?.split(' ').pop()}</div>{t&&<SectorBar s1={t.s1_status} s2={t.s2_status} s3={t.s3_status}/>}</div>
                                            <div style={{textAlign:'center',fontSize:12,fontWeight:600,color:t?.is_best_lap?'#A020F0':t?.is_personal_best?'#39B54A':'var(--f1-text-secondary)',fontVariantNumeric:'tabular-nums'}}>{t?fmtLap(t.lap_duration):'‚Äî'}</div>
                                            <div style={{textAlign:'center',position:'relative'}}><TyreIcon compound={p.tyre}/>{p.tyre_age>0&&<div style={{fontSize:8,color:'var(--f1-text-muted)',position:'absolute',bottom:-4,left:'50%',transform:'translateX(-50%)',fontWeight:600}}>{p.tyre_age}L</div>}</div>
                                            <div style={{textAlign:'right',fontSize:11,fontWeight:600,color:'var(--f1-text-secondary)',fontVariantNumeric:'tabular-nums'}}>{i===0?<span style={{color:'var(--f1-text-muted)',fontSize:10}}>INT</span>:t?.interval?`+${t.interval}`:t?.gap_to_leader?`+${t.gap_to_leader}`:'‚Äî'}</div>
                                            <div style={{textAlign:'center',fontSize:12,color:'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>{p.pit_stops||0}</div>
                                        </div>
                                        {isExp && t && (
                                            <div style={{padding:'4px 12px 12px',display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:6,background:'rgba(255,255,255,0.015)',borderBottom:'1px solid var(--f1-border)',animation:'fadeIn 0.2s ease-out'}}>
                                                <div className={`sector-time st-${t.s1_status}`}><div style={{fontSize:9,opacity:0.6,marginBottom:2}}>S1</div>{fmtSector(t.sector_1)}</div>
                                                <div className={`sector-time st-${t.s2_status}`}><div style={{fontSize:9,opacity:0.6,marginBottom:2}}>S2</div>{fmtSector(t.sector_2)}</div>
                                                <div className={`sector-time st-${t.s3_status}`}><div style={{fontSize:9,opacity:0.6,marginBottom:2}}>S3</div>{fmtSector(t.sector_3)}</div>
                                                <div style={{gridColumn:'1/-1',display:'flex',justifyContent:'space-between',fontSize:11,color:'var(--f1-text-muted)',padding:'4px 4px 0'}}>
                                                    <span>–ö—Ä—É–≥ {t.lap_number}</span><span>–°—Ç–∏–Ω—Ç #{p.stint_number} ¬∑ {p.tyre} {p.tyre_age>0?`(${p.tyre_age} –∫—Ä—É–≥–æ–≤)`:''}</span>{t.gap_to_leader&&<span>–û—Ç—Å—Ç.: +{t.gap_to_leader}</span>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div style={{textAlign:'center',padding:'50px 20px',color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üèéÔ∏è</div><div style={{fontSize:16,fontWeight:700,marginBottom:4}}>{isLive?'–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...':'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏'}</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–µ—Å—Å–∏—è</div></div>
                    ))}

                    {/* TRACK MAP TAB */}
                    {liveTab==='track' && (trackMapData?.track?.points?.length > 0 ? (() => {
                        const pts = trackMapData.track.points;
                        const cars = trackMapData.cars || [];
                        const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
                        const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
                        const rangeX=maxX-minX||1, rangeY=maxY-minY||1;
                        const pad=30, size=400;
                        const scale=Math.min((size-2*pad)/rangeX,(size-2*pad)/rangeY);
                        const cx=(size-(rangeX*scale))/2, cy=(size-(rangeY*scale))/2;
                        const tx = (x) => cx + (x-minX)*scale;
                        const ty = (y) => cy + (y-minY)*scale;
                        const trackPath = pts.map((p,i)=>`${i===0?'M':'L'}${tx(p.x).toFixed(1)},${ty(p.y).toFixed(1)}`).join(' ')+'Z';
                        const leader = cars.length > 0 ? cars[0] : null;
                        return (
                            <div style={{padding:'8px 12px'}}>
                                <svg viewBox={`0 0 ${size} ${size}`} style={{width:'100%',maxWidth:400,margin:'0 auto',display:'block'}}>
                                    {/* Track glow */}
                                    <path d={trackPath} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="16" strokeLinecap="round" strokeLinejoin="round"/>
                                    {/* Track outline */}
                                    <path d={trackPath} fill="none" stroke="rgba(255,255,255,0.15)" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round"/>
                                    {/* Car dots */}
                                    {cars.map(car => {
                                        const carX = tx(car.x), carY = ty(car.y);
                                        const isLeader = car.driver_number === leader?.driver_number;
                                        const isSel = selectedCar === car.driver_number;
                                        return (
                                            <g key={car.driver_number} style={{cursor:'pointer'}} onClick={()=>setSelectedCar(isSel?null:car.driver_number)}>
                                                <circle cx={carX} cy={carY} r="6" fill={car.team_color||'#888'} style={{transition:'cx 0.8s ease, cy 0.8s ease'}}/>
                                                {isLeader && <circle cx={carX} cy={carY} r="10" fill="none" stroke={car.team_color||'#888'} strokeWidth="1.5" opacity="0.6">
                                                    <animate attributeName="r" values="10;14;10" dur="1.5s" repeatCount="indefinite"/>
                                                    <animate attributeName="opacity" values="0.6;0.1;0.6" dur="1.5s" repeatCount="indefinite"/>
                                                </circle>}
                                                <text x={carX} y={carY-10} textAnchor="middle" fill="white" fontSize="8" fontWeight="700" fontFamily="Titillium Web,sans-serif" style={{transition:'x 0.8s ease, y 0.8s ease'}}>{car.code}</text>
                                            </g>
                                        );
                                    })}
                                </svg>
                                {/* Selected car popup */}
                                {selectedCar && (() => {
                                    const car = cars.find(c=>c.driver_number===selectedCar);
                                    if (!car) return null;
                                    return (
                                        <div className="card" onClick={()=>setSelectedCar(null)} style={{margin:'12px 0',padding:12,display:'flex',alignItems:'center',gap:10,animation:'fadeIn 0.2s ease-out'}}>
                                            <div style={{background:car.team_color,width:4,height:36,borderRadius:2}}/>
                                            {car.photo_url && <DriverPhoto url={car.photo_url} size={36}/>}
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:900,fontSize:15}}>{car.code} <span style={{fontWeight:400,color:'var(--f1-text-secondary)',fontSize:13}}>{car.name}</span></div>
                                                <div style={{fontSize:11,color:car.team_color,fontWeight:600}}>{car.team}</div>
                                            </div>
                                            <div style={{textAlign:'right'}}>
                                                <PosBadge pos={car.position||0}/>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {/* Driver legend */}
                                <div style={{display:'flex',flexWrap:'wrap',gap:4,marginTop:8}}>
                                    {cars.map(c=>(
                                        <div key={c.driver_number} onClick={()=>setSelectedCar(selectedCar===c.driver_number?null:c.driver_number)}
                                             style={{display:'flex',alignItems:'center',gap:3,fontSize:10,padding:'2px 6px',borderRadius:4,background:selectedCar===c.driver_number?`${c.team_color}33`:`${c.team_color}11`,color:c.team_color,fontWeight:600,cursor:'pointer'}}>
                                            <span style={{width:6,height:6,borderRadius:'50%',background:c.team_color}}/>{c.code}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })() : (
                        <div style={{textAlign:'center',padding:'50px 20px',color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üó∫Ô∏è</div><div style={{fontSize:16,fontWeight:700,marginBottom:4}}>–ö–∞—Ä—Ç–∞ —Ç—Ä–∞—Å—Å—ã –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –º–∞—à–∏–Ω –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏</div></div>
                    ))}

                    {liveTab==='sectors' && (timing?.timing?.length>0 ? (
                        <div style={{padding:'0 8px'}}>
                            <div style={{display:'grid',gridTemplateColumns:'40px 1fr 64px 64px 64px 72px',gap:4,padding:'6px 8px',fontSize:10,color:'var(--f1-text-muted)',fontWeight:600,textTransform:'uppercase',borderBottom:'1px solid var(--f1-border)'}}>
                                <span>–ö–æ–¥</span><span></span><span style={{textAlign:'center'}}>S1</span><span style={{textAlign:'center'}}>S2</span><span style={{textAlign:'center'}}>S3</span><span style={{textAlign:'center'}}>–ö—Ä—É–≥</span>
                            </div>
                            {(positions?.positions||[]).map((p,i) => {
                                const t = timingMap[p.driver_number]; if(!t) return null;
                                return (
                                    <div key={p.driver_number} style={{display:'grid',gridTemplateColumns:'40px 1fr 64px 64px 64px 72px',gap:4,padding:'7px 8px',alignItems:'center',borderBottom:'1px solid var(--f1-border)',fontSize:12,background:i%2?`${p.team_color}06`:'transparent'}}>
                                        <span style={{fontWeight:700,color:p.team_color}}>{p.code}</span>
                                        <div style={{width:4,height:20,background:p.team_color,borderRadius:2}}/>
                                        <div className={`sector-time st-${t.s1_status}`}>{fmtSector(t.sector_1)}</div>
                                        <div className={`sector-time st-${t.s2_status}`}>{fmtSector(t.sector_2)}</div>
                                        <div className={`sector-time st-${t.s3_status}`}>{fmtSector(t.sector_3)}</div>
                                        <div style={{textAlign:'center',fontWeight:700,color:t.is_best_lap?'#A020F0':t.is_personal_best?'#39B54A':'var(--f1-text-secondary)',fontVariantNumeric:'tabular-nums'}}>{fmtLap(t.lap_duration)}</div>
                                    </div>
                                );
                            })}
                            {timing.session_best && (
                                <div style={{padding:'12px 8px',borderTop:'2px solid var(--f1-border)',marginTop:4}}>
                                    <div style={{fontSize:10,color:'#A020F0',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8}}>–õ—É—á—à–∏–µ —Å–µ–∫—Ç–æ—Ä—ã —Å–µ—Å—Å–∏–∏</div>
                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:6}}>
                                        {[{label:'S1',val:timing.session_best.sector_1},{label:'S2',val:timing.session_best.sector_2},{label:'S3',val:timing.session_best.sector_3},{label:'–ö—Ä—É–≥',val:timing.session_best.lap}].map((s,i)=>(
                                            <div key={i} className="sector-time st-best" style={{padding:8}}><div style={{fontSize:9,opacity:0.6,marginBottom:2}}>{s.label}</div>{i<3?fmtSector(s.val):fmtLap(s.val)}</div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)',fontSize:13}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º</div>)}

                    {liveTab==='pits' && (pitData?.pit_stops?.length>0 ? (
                        <div>{pitData.pit_stops.slice().reverse().map((p,i)=>(
                            <div key={i} className="pit-entry">
                                <div style={{width:36,height:36,borderRadius:10,background:`${p.team_color}22`,display:'flex',alignItems:'center',justifyContent:'center',fontWeight:900,fontSize:13,color:p.team_color,flexShrink:0}}>{p.code||p.driver_number}</div>
                                <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14}}>{p.name}</div><div style={{fontSize:11,color:'var(--f1-text-muted)'}}>–ö—Ä—É–≥ {p.lap_number||'?'} ¬∑ {p.team}</div></div>
                                <div className="pit-time" style={{color:p.pit_duration&&p.pit_duration<25?'#39B54A':p.pit_duration&&p.pit_duration<30?'var(--f1-text)':'#FFD700'}}>{p.pit_duration?`${p.pit_duration.toFixed(1)}s`:'‚Äî'}</div>
                            </div>
                        ))}</div>
                    ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)',fontSize:13}}><div style={{fontSize:32,marginBottom:8}}>üîß</div>–ù–µ—Ç –ø–∏—Ç-—Å—Ç–æ–ø–æ–≤</div>)}

                    {liveTab==='radio' && (radioData?.radio?.length>0 ? (
                        <div><audio ref={audioRef}/>
                            {radioData.radio.slice().reverse().map((r,i)=>{
                                const t = transcripts[r.recording_url];
                                const isLoading = transcribing[r.recording_url];
                                return (
                                <div key={i} style={{padding:'12px 16px',borderBottom:'1px solid var(--f1-border)',animation:i<2?'fadeIn 0.3s ease-out':'none'}}>
                                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                                        <button className="radio-play-btn" onClick={()=>r.recording_url&&playRadio(r.recording_url)}>{audioPlaying===r.recording_url?'‚è∏':'‚ñ∂'}</button>
                                        <div style={{flex:1,minWidth:0}}>
                                            <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                                                <div style={{width:4,height:20,borderRadius:2,background:r.team_color}}/>
                                                <span style={{fontWeight:700,fontSize:14}}>{r.code||r.name}</span>
                                                <span style={{fontSize:11,color:'var(--f1-text-muted)'}}>{r.team}</span>
                                                <span style={{fontSize:10,color:'var(--f1-text-muted)',marginLeft:'auto'}}>{r.date?new Date(r.date).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'}):''}</span>
                                            </div>
                                        </div>
                                        {radioData.transcription_available && r.recording_url && !t && (
                                            <button onClick={()=>handleTranscribe(r.recording_url)} disabled={isLoading} style={{background:'rgba(255,255,255,0.06)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'4px 8px',color:isLoading?'var(--f1-text-muted)':'var(--f1-text-secondary)',fontSize:10,fontWeight:600,cursor:isLoading?'wait':'pointer',fontFamily:'inherit',flexShrink:0,transition:'all 0.2s'}}>
                                                {isLoading ? '‚è≥' : 'üìù'}
                                            </button>
                                        )}
                                    </div>
                                    {t && !t.error && (
                                        <div style={{marginTop:8,marginLeft:46,padding:'8px 10px',background:'rgba(255,255,255,0.03)',borderRadius:8,borderLeft:'3px solid var(--f1-text-muted)'}}>
                                            {t.text_en && <div style={{fontSize:12,color:'var(--f1-text-secondary)',lineHeight:1.4}}>üá¨üáß {t.text_en}</div>}
                                            {t.text_ru && <div style={{fontSize:13,color:'var(--f1-text)',fontWeight:600,marginTop:4,lineHeight:1.4}}>üá∑üá∫ {t.text_ru}</div>}
                                            {!t.text_en && <div style={{fontSize:12,color:'var(--f1-text-muted)',fontStyle:'italic'}}>üéôÔ∏è [–Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–æ]</div>}
                                        </div>
                                    )}
                                    {t?.error && <div style={{marginTop:6,marginLeft:46,fontSize:11,color:'var(--f1-red)'}}>{t.error}</div>}
                                </div>
                            );})}
                        </div>
                    ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)',fontSize:13}}><div style={{fontSize:32,marginBottom:8}}>üìª</div>–ù–µ—Ç —Ä–∞–¥–∏–æ–ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤</div>)}

                    {liveTab==='messages' && (raceControl?.messages?.length>0 ? (
                        <div style={{padding:'4px 0'}}>{raceControl.messages.slice().reverse().map((msg,i)=>(
                            <div key={i} style={{display:'flex',alignItems:'flex-start',gap:10,padding:'10px 16px',borderBottom:'1px solid var(--f1-border)'}}>
                                <FlagIcon flag={msg.flag||'GREEN'}/>
                                <div style={{flex:1}}>
                                    <div style={{fontSize:13,lineHeight:1.4}}>{msg.message_ru && msg.message_ru !== msg.message ? msg.message_ru : msg.message}</div>
                                    {msg.message_ru && msg.message_ru !== msg.message && <div style={{fontSize:11,color:'var(--f1-text-muted)',marginTop:2,fontStyle:'italic'}}>{msg.message}</div>}
                                    <div style={{fontSize:11,color:'var(--f1-text-muted)',marginTop:3,display:'flex',gap:8}}>
                                        {msg.lap_number&&<span>–ö—Ä—É–≥ {msg.lap_number}</span>}{msg.driver_number&&<span>#{msg.driver_number}</span>}{msg.category&&<span>{{Other:'–î—Ä—É–≥–æ–µ',Flag:'–§–ª–∞–≥',SafetyCar:'–°–µ–π—Ñ—Ç–∏-–∫–∞—Ä',VirtualSafetyCar:'–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –°–ö',DRS:'DRS',SessionStatus:'–°—Ç–∞—Ç—É—Å'}[msg.category]||msg.category}</span>}{msg.date&&<span>{new Date(msg.date).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}</span>}
                                    </div>
                                </div>
                            </div>
                        ))}</div>
                    ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)',fontSize:13}}><div style={{fontSize:32,marginBottom:8}}>üìã</div>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏—Ä–µ–∫—Ü–∏–∏</div>)}
                </div>
            );
        };

        // ==== NEWS PAGE ====
        const NewsPage = () => {
            const [news, setNews] = useState(null);
            const [loading, setLoading] = useState(true);
            useEffect(() => { api.get('/api/news').then(d => { setNews(d); setLoading(false); }); }, []);

            if (loading) return <div className="page-container fade-in" style={{padding:16}}><CardSkeleton/><div style={{height:12}}/><CardSkeleton/><div style={{height:12}}/><CardSkeleton/></div>;

            return (
                <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                    <h2 style={{fontSize:22,fontWeight:900,marginBottom:4}}>–ù–æ–≤–æ—Å—Ç–∏ –§-1</h2>
                    <div style={{fontSize:13,color:'var(--f1-text-secondary)',marginBottom:16,display:'flex',alignItems:'center',gap:6}}>
                        <span style={{width:6,height:6,borderRadius:'50%',background:'var(--f1-red)',display:'inline-block'}}/>
                        {news?.source || 'championat.com'}
                    </div>

                    {news?.posts?.length > 0 ? (
                        news.posts.map((post,i) => (
                            <div key={i} className="news-card" onClick={()=>post.url && openLink(post.url)}>
                                {post.photo && <img src={post.photo} alt="" className="news-card-img" onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                <div className="news-card-body">
                                    {post.title && <div className="news-card-title">{post.title}</div>}
                                    {post.preview && <div className="news-card-preview">{post.preview}</div>}
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                        <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{post.date_text || ''}</div>
                                        <span style={{fontSize:12,color:'var(--f1-red)',fontWeight:600}}>–ß–∏—Ç–∞—Ç—å ‚Üí</span>
                                    </div>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="card" style={{textAlign:'center',padding:'40px 20px'}}>
                            <div style={{fontSize:48,marginBottom:12}}>üì∞</div>
                            <div style={{fontSize:15,fontWeight:700,marginBottom:8}}>–ù–æ–≤–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                            <div style={{fontSize:13,color:'var(--f1-text-muted)',marginBottom:16}}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –§–æ—Ä–º—É–ª—ã-1</div>
                            <button className="btn-primary" onClick={()=>openLink('https://www.championat.com/auto/_f1.html')}>–û—Ç–∫—Ä—ã—Ç—å championat.com</button>
                        </div>
                    )}
                </div>
            );
        };

        // ==== SCHEDULE PAGE ====
        const circuitFlags = {
            'albert_park':'üá¶üá∫','shanghai':'üá®üá≥','suzuka':'üáØüáµ','bahrain':'üáßüá≠',
            'jeddah':'üá∏üá¶','miami':'üá∫üá∏','imola':'üáÆüáπ','monaco':'üá≤üá®',
            'catalunya':'üá™üá∏','villeneuve':'üá®üá¶','red_bull_ring':'üá¶üáπ','silverstone':'üá¨üáß',
            'spa':'üáßüá™','hungaroring':'üá≠üá∫','zandvoort':'üá≥üá±','monza':'üáÆüáπ',
            'baku':'üá¶üáø','marina_bay':'üá∏üá¨','cota':'üá∫üá∏','americas':'üá∫üá∏','rodriguez':'üá≤üáΩ',
            'interlagos':'üáßüá∑','las_vegas':'üá∫üá∏','vegas':'üá∫üá∏','lusail':'üá∂üá¶','losail':'üá∂üá¶','yas_marina':'üá¶üá™',
            'madring':'üá™üá∏'
        };

        const countryFlag = (code) => {
            if (!code) return '';
            return String.fromCodePoint(...[...code.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
        };
        const toMSK = (utcTime) => {
            if (!utcTime) return '';
            const [h, m] = utcTime.replace('Z','').split(':');
            const msk = (parseInt(h) + 3) % 24;
            return `${String(msk).padStart(2,'0')}:${m} –ú–°–ö`;
        };

        const SchedulePage = ({seasonResults, schedule, season, onRaceClick, spoilerFree, onToggleSpoiler}) => {
            const races = (seasonResults?.races?.length ? seasonResults.races : null) || schedule?.races || [];
            if (!races.length) return <div className="page-container fade-in" style={{padding:16}}>{[1,2,3,4].map(i=><div key={i}><CardSkeleton/><div style={{height:12}}/></div>)}</div>;

            const now = new Date();
            const lastCompletedRound = races.filter(r => new Date(r.date) < now).pop();
            const isSpoilerActive = spoilerFree && season === 2026;

            return (
                <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:4}}>
                        <h2 style={{fontSize:22,fontWeight:900}}>–°–µ–∑–æ–Ω {season}</h2>
                        {season === 2026 && <div style={{display:'flex',alignItems:'center',gap:8}}>
                            <span style={{fontSize:11,color:spoilerFree?'var(--f1-red)':'var(--f1-text-muted)',fontWeight:600}}>üîí –ë–µ–∑ —Å–ø–æ–π–ª–µ—Ä–æ–≤</span>
                            <div onClick={onToggleSpoiler} style={{width:44,height:24,borderRadius:12,background:spoilerFree?'var(--f1-red)':'#333',position:'relative',cursor:'pointer',transition:'background 0.3s'}}>
                                <div style={{width:20,height:20,borderRadius:10,background:'#fff',position:'absolute',top:2,left:spoilerFree?22:2,transition:'left 0.3s'}}/>
                            </div>
                        </div>}
                    </div>
                    <div style={{fontSize:13,color:'var(--f1-text-secondary)',marginBottom:16}}>{races.length} –≥—Ä–∞–Ω-–ø—Ä–∏{seasonResults?.races?.length ? ' ¬∑ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' : ''}</div>

                    {races.map((race) => {
                        const isPast = new Date(race.date) < now;
                        const flag = countryFlag(race.country_code) || circuitFlags[race.circuit_id] || 'üèÅ';
                        const dateStr = new Date(race.date).toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
                        const raceTime = toMSK(race.time);
                        const winner = race.winner;
                        const shouldHide = isSpoilerActive && lastCompletedRound && race.round === lastCompletedRound.round;

                        return (
                            <div key={race.round} className="card" onClick={() => onRaceClick(race.round)}
                                 style={{marginBottom:8, padding:12, cursor: shouldHide ? 'default' : 'pointer', opacity: isPast ? 1 : 0.6, position:'relative', overflow:'hidden'}}>
                                {race.circuit_image && <img src={race.circuit_image} alt="" style={{position:'absolute',top:0,right:0,width:80,height:'100%',objectFit:'contain',opacity:0.05,pointerEvents:'none'}}/>}
                                <div style={{display:'flex',alignItems:'center',gap:10,position:'relative'}}>
                                    <div style={{width:36,height:36,borderRadius:10,background:isPast?'rgba(225,6,0,0.15)':'rgba(255,255,255,0.05)',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:900,fontSize:14,flexShrink:0,color:isPast?'var(--f1-red)':'var(--f1-text-muted)'}}>{race.round}</div>
                                    <div style={{flex:1,minWidth:0}}>
                                        <div style={{display:'flex',alignItems:'center',gap:5,flexWrap:'wrap'}}>
                                            <span>{flag}</span>
                                            <span style={{fontWeight:700,fontSize:14}}>{race.name}</span>
                                            {race.sprint ? (
                                                <span style={{background:'rgba(255,128,0,0.2)',color:'#FF8000',fontSize:9,fontWeight:700,padding:'1px 5px',borderRadius:4,letterSpacing:0.5}}>–°–ü–†–ò–ù–¢ + –ì–û–ù–ö–ê</span>
                                            ) : (
                                                <span style={{background:'rgba(225,6,0,0.15)',color:'var(--f1-red)',fontSize:9,fontWeight:700,padding:'1px 5px',borderRadius:4,letterSpacing:0.5}}>–ì–û–ù–ö–ê</span>
                                            )}
                                        </div>
                                        <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{race.circuit || race.circuit_name} ¬∑ {dateStr}{raceTime ? ` ¬∑ ${raceTime}` : ''}</div>
                                    </div>
                                    {shouldHide ? (
                                        <div style={{display:'flex',alignItems:'center',gap:4,padding:'4px 10px',background:'rgba(225,6,0,0.1)',border:'1px solid rgba(225,6,0,0.2)',borderRadius:8,flexShrink:0}}>
                                            <span style={{fontSize:12}}>üîí</span>
                                            <span style={{fontSize:10,color:'var(--f1-red)',fontWeight:600}}>–°–∫—Ä—ã—Ç–æ</span>
                                        </div>
                                    ) : (<>
                                        {isPast && winner && (
                                            <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                                                {winner.photo_url && <img src={winner.photo_url} alt="" style={{width:28,height:28,borderRadius:'50%',objectFit:'cover',border:'2px solid #FFD700',background:'var(--f1-gray)'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                <div style={{textAlign:'right'}}>
                                                    <div style={{fontSize:12,fontWeight:900,color:'#FFD700'}}>{winner.code}</div>
                                                    <div style={{fontSize:9,color:'var(--f1-text-muted)'}}>{winner.team?.split(' ')[0]}</div>
                                                </div>
                                            </div>
                                        )}
                                        {(race.vk_url || race.vk_search_url) && isPast && (
                                            <button onClick={(e)=>{e.stopPropagation();openLink(race.vk_url || race.vk_search_url);}} style={{background:'rgba(0,119,255,0.15)',border:'1px solid rgba(0,119,255,0.3)',borderRadius:8,padding:'4px 8px',color:'#4DA3FF',fontSize:10,fontWeight:700,cursor:'pointer',fontFamily:'inherit',flexShrink:0}}>
                                                {race.vk_url ? 'üì∫' : 'üîç'}
                                            </button>
                                        )}
                                    </>)}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ==== STANDINGS PAGE ====
        const StandingsPage = ({driversStandings, constructorsStandings, season}) => {
            const [tab, setTab] = useState('drivers');
            const [selectedDriver, setSelectedDriver] = useState(null);
            const [driverDetail, setDriverDetail] = useState(null);
            const [allDrivers, setAllDrivers] = useState(null);
            const [teamsData, setTeamsData] = useState(null);
            useEffect(() => {
                setAllDrivers(null); setTeamsData(null); setSelectedDriver(null); setDriverDetail(null);
                if (tab==='cards') api.get(`/api/drivers?season=${season}`).then(d=>setAllDrivers(d?.drivers||[]));
                if (tab==='teams') api.get(`/api/teams?season=${season}`).then(d=>setTeamsData(d?.teams||[]));
            }, [tab, season]);

            const openDriver = async (num) => { setSelectedDriver(num); setDriverDetail(await api.get(`/api/driver/${num}?season=${season}`)); };

            if (selectedDriver && driverDetail) {
                const d = driverDetail, stats = d.season_stats;
                return (
                    <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                        <button onClick={()=>{setSelectedDriver(null);setDriverDetail(null);}} style={{background:'none',border:'none',color:'var(--f1-text-muted)',fontSize:13,fontFamily:'inherit',cursor:'pointer',marginBottom:12,display:'flex',alignItems:'center',gap:4}}>‚Üê –ù–∞–∑–∞–¥</button>
                        <div className="gradient-card" style={{marginBottom:16}}>
                            <div style={{position:'absolute',top:0,left:0,bottom:0,width:6,background:d.team_color,borderRadius:'16px 0 0 16px'}}/>
                            <div style={{display:'flex',alignItems:'center',gap:12,paddingLeft:12}}>
                                {d.photo_url && <img src={d.photo_url} alt="" style={{width:64,height:64,borderRadius:12,objectFit:'cover',background:'var(--f1-gray)',border:`2px solid ${d.team_color}`}} onError={e=>{e.target.style.display='none'}}/>}
                                <div>
                                    <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{flagEmoji(d.country)} {d.country}</div>
                                    <div style={{fontSize:20,fontWeight:900,lineHeight:1.1}}>{d.first_name}<br/><span style={{color:d.team_color}}>{d.last_name}</span></div>
                                    <div style={{fontSize:12,color:'var(--f1-text-secondary)',marginTop:2}}>{d.team}</div>
                                </div>
                                <div style={{marginLeft:'auto',fontSize:36,fontWeight:900,opacity:0.15,color:d.team_color}}>{d.driver_number}</div>
                            </div>
                        </div>
                        {stats && (<>
                            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:16}}>
                                {[{val:stats.points,label:'–û—á–∫–∏'},{val:stats.wins,label:'–ü–æ–±–µ–¥'},{val:stats.podiums,label:'–ü–æ–¥–∏—É–º'},{val:stats.dnfs,label:'–°—Ö–æ–¥—ã'}].map((s,i)=>(
                                    <div key={i} className="card" style={{textAlign:'center',padding:10}}><div style={{fontSize:20,fontWeight:900}}>{s.val}</div><div style={{fontSize:10,color:'var(--f1-text-muted)'}}>{s.label}</div></div>
                                ))}
                            </div>
                            <div className="card"><div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ–∑–æ–Ω–∞</div>
                                {stats.results?.map((r,i)=>(
                                    <div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'7px 0',borderBottom:i<stats.results.length-1?'1px solid var(--f1-border)':'none'}}>
                                        <span style={{width:30,fontSize:11,color:'var(--f1-text-muted)'}}>R{r.round}</span><span style={{flex:1,fontSize:13}}>{r.race?.replace('Grand Prix','–ì–ü')}</span><PosBadge pos={r.position}/><span style={{width:36,textAlign:'right',fontSize:13,fontWeight:700,color:r.points>0?'var(--f1-text)':'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>{r.points>0?`+${r.points}`:'0'}</span>
                                    </div>
                                ))}
                            </div>
                        </>)}
                        {d.teammate && (
                            <div className="card" style={{marginTop:12}}>
                                <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8}}>–ù–∞–ø–∞—Ä–Ω–∏–∫</div>
                                <div style={{display:'flex',alignItems:'center',gap:10}}>
                                    {d.teammate.photo_url && <DriverPhoto url={d.teammate.photo_url} size={36}/>}
                                    <div><div style={{fontWeight:700,fontSize:14}}>{d.teammate.name}</div><div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{flagEmoji(d.teammate.country)} {d.teammate.code}</div></div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const notStarted = (tab==='drivers' && driversStandings?.not_started) || (tab==='constructors' && constructorsStandings?.not_started);
            const data = tab==='drivers'?driversStandings:tab==='constructors'?constructorsStandings:null;
            const leaderPts = data?.standings?.[0]?.points || 1;

            // Build large photo URL from regular photo URL
            const largePhoto = (url) => url ? url.replace('/2col/','/4col/').replace('/1col/','/4col/') : null;

            return (
                <div className="page-container fade-in">
                    <div style={{padding:'12px 16px'}}>
                        <h2 style={{fontSize:22,fontWeight:900,marginBottom:12}}>–ß–µ–º–ø–∏–æ–Ω–∞—Ç</h2>
                        <div className="tab-switch" style={{marginBottom:16}}>
                            <button className={`tab-switch-btn ${tab==='drivers'?'active':''}`} onClick={()=>setTab('drivers')}>–ü–∏–ª–æ—Ç—ã</button>
                            <button className={`tab-switch-btn ${tab==='constructors'?'active':''}`} onClick={()=>setTab('constructors')}>–ö—É–±–æ–∫</button>
                            <button className={`tab-switch-btn ${tab==='cards'?'active':''}`} onClick={()=>setTab('cards')}>–ö–∞—Ä—Ç–æ—á–∫–∏</button>
                            <button className={`tab-switch-btn ${tab==='teams'?'active':''}`} onClick={()=>setTab('teams')}>–ö–æ–º–∞–Ω–¥—ã</button>
                        </div>
                    </div>

                    {/* Not started placeholder */}
                    {notStarted && (
                        <div style={{textAlign:'center',padding:'50px 20px',color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üèÅ</div><div style={{fontSize:16,fontWeight:700,marginBottom:4}}>–°–µ–∑–æ–Ω {season} –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è</div><div style={{fontSize:13}}>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–æ–Ω–∫–∏</div></div>
                    )}

                    {/* DRIVERS STANDINGS */}
                    {tab==='drivers' && !notStarted && (!data?.standings ? (
                        <div style={{padding:16}}>{[1,2,3,4,5].map(i=><Skeleton key={i} h="64px" r="16px" className="mb-3"/>)}</div>
                    ) : (
                        <div style={{padding:'0 12px'}}>
                            {/* Top 3 podium cards */}
                            <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:12}}>
                                {data.standings.slice(0,3).map((s,i)=>(
                                    <div key={i} className="gradient-card" onClick={()=>s.driver_number&&openDriver(s.driver_number)}
                                         style={{cursor:'pointer',padding:14,background:`linear-gradient(135deg,${s.team_color}20,var(--f1-card) 70%)`,borderLeft:`4px solid ${s.team_color}`}}>
                                        <div style={{display:'flex',alignItems:'center',gap:12}}>
                                            <div style={{fontSize:28,fontWeight:900,color:['#FFD700','#C0C0C0','#CD7F32'][i],minWidth:32,textAlign:'center',lineHeight:1}}>{s.position}</div>
                                            {s.photo_url && <img src={s.photo_url} alt="" style={{width:56,height:56,borderRadius:'50%',objectFit:'cover',background:'var(--f1-gray)',border:`3px solid ${s.team_color}`,flexShrink:0}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                            <div style={{flex:1,minWidth:0}}>
                                                <div style={{fontWeight:900,fontSize:16}}>{s.name}</div>
                                                <div style={{fontSize:12,color:s.team_color,fontWeight:600}}>{s.team}</div>
                                                <div className="progress-bar-bg" style={{marginTop:4,maxWidth:140}}>
                                                    <div className="progress-bar-fill" style={{width:`${Math.max(5,(s.points/leaderPts)*100)}%`,background:s.team_color}}/>
                                                </div>
                                            </div>
                                            <div style={{textAlign:'right'}}>
                                                <div style={{fontWeight:900,fontSize:22,fontVariantNumeric:'tabular-nums'}}>{s.points}</div>
                                                <div style={{fontSize:10,color:'var(--f1-text-muted)'}}>–æ—á–∫–æ–≤</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="divider-line" style={{margin:'8px 4px'}}/>

                            {/* Rest of grid */}
                            {data.standings.slice(3).map((s,i)=>(
                                <React.Fragment key={i}>
                                    {i===7 && <div className="divider-line" style={{margin:'4px 4px'}}/>}
                                    <div className="standings-row" onClick={()=>s.driver_number&&openDriver(s.driver_number)} style={{cursor:'pointer',padding:'10px 8px',gap:10}}>
                                        <div style={{width:28,fontWeight:900,fontSize:15,color:'var(--f1-text-muted)',textAlign:'center',fontVariantNumeric:'tabular-nums'}}>{s.position}</div>
                                        <div style={{background:s.team_color,width:4,height:40,borderRadius:2}}/>
                                        {s.photo_url && <img src={s.photo_url} alt="" style={{width:40,height:40,borderRadius:'50%',objectFit:'cover',background:'var(--f1-gray)',border:`2px solid ${s.team_color}`,flexShrink:0}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                        <div style={{flex:1,minWidth:0}}>
                                            <div style={{fontWeight:700,fontSize:14}}>{s.name}</div>
                                            <div style={{fontSize:11,color:'var(--f1-text-muted)'}}>{s.team}</div>
                                        </div>
                                        <div style={{textAlign:'right'}}>
                                            <div style={{fontWeight:900,fontSize:16,fontVariantNumeric:'tabular-nums'}}>{s.points}</div>
                                            {s.gap_to_leader>0 && <div style={{fontSize:10,color:'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>-{s.gap_to_leader}</div>}
                                        </div>
                                    </div>
                                </React.Fragment>
                            ))}
                        </div>
                    ))}

                    {/* CONSTRUCTORS STANDINGS */}
                    {tab==='constructors' && !notStarted && (!constructorsStandings?.standings ? (
                        <div style={{padding:16}}>{[1,2,3,4,5].map(i=><Skeleton key={i} h="56px" r="16px" className="mb-3"/>)}</div>
                    ) : (
                        <div style={{padding:'0 12px'}}>
                            {constructorsStandings.standings.map((s,i)=>{
                                const cLeader = constructorsStandings.standings[0]?.points || 1;
                                const driverPoints = s.drivers?.map(d => {
                                    const ds = driversStandings?.standings?.find(x => x.driver_number === d.driver_number);
                                    return {code: d.code, photo_url: d.photo_url, points: ds?.points || 0, driver_number: d.driver_number};
                                }) || [];
                                return (
                                    <div key={i} className="card" style={{marginBottom:8,padding:12,borderLeft:`4px solid ${s.team_color}`}}>
                                        <div style={{display:'flex',alignItems:'center',gap:10}}>
                                            <div style={{fontSize:20,fontWeight:900,color:i<3?['#FFD700','#C0C0C0','#CD7F32'][i]:'var(--f1-text-muted)',minWidth:28,textAlign:'center'}}>{s.position}</div>
                                            {s.logo_url && <img src={s.logo_url} alt="" style={{width:36,height:36,objectFit:'contain',flexShrink:0}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                            <div style={{flex:1,minWidth:0}}>
                                                <div style={{fontWeight:700,fontSize:15}}>{s.team}</div>
                                                <div style={{display:'flex',gap:8,marginTop:6,alignItems:'center'}}>
                                                    {driverPoints.map((d,j)=>(
                                                        <div key={j} onClick={(e)=>{e.stopPropagation();d.driver_number&&openDriver(d.driver_number);}} style={{display:'flex',alignItems:'center',gap:4,cursor:'pointer',padding:'3px 8px',background:'rgba(255,255,255,0.03)',borderRadius:8,border:'1px solid var(--f1-border)'}}>
                                                            {d.photo_url && <img src={d.photo_url} alt="" style={{width:22,height:22,borderRadius:'50%',objectFit:'cover',background:'var(--f1-gray)'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                            <span style={{fontSize:11,fontWeight:700}}>{d.code}</span>
                                                            <span style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:600,fontVariantNumeric:'tabular-nums'}}>{d.points}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                {s.points > 0 && (
                                                    <div style={{display:'flex',height:6,borderRadius:3,overflow:'hidden',marginTop:6,background:'var(--f1-gray)',gap:1}}>
                                                        {driverPoints.map((d,j)=>{
                                                            const w = Math.max(3, (d.points / s.points) * 100);
                                                            return <div key={j} style={{width:`${w}%`,background:j===0?s.team_color:`${s.team_color}99`,borderRadius:3,transition:'width 0.5s ease'}}/>;
                                                        })}
                                                    </div>
                                                )}
                                                {s.points === 0 && (
                                                    <div className="progress-bar-bg" style={{marginTop:6,maxWidth:140}}>
                                                        <div className="progress-bar-fill" style={{width:'3%',background:s.team_color}}/>
                                                    </div>
                                                )}
                                            </div>
                                            <div style={{textAlign:'right'}}>
                                                <div style={{fontWeight:900,fontSize:18,fontVariantNumeric:'tabular-nums'}}>{s.points}</div>
                                                {i>0 && <div style={{fontSize:10,color:'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>-{constructorsStandings.standings[0].points-s.points}</div>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ))}

                    {/* DRIVER CARDS ‚Äî redesigned with big photos */}
                    {tab==='cards' && (
                        <div style={{padding:'0 12px'}}>
                            {!allDrivers ? (
                                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>{[1,2,3,4,5,6].map(i=><Skeleton key={i} h="240px" r="16px"/>)}</div>
                            ) : (
                                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                                    {allDrivers.map(d=>{
                                        const bigPhoto = d.photo_url_large || largePhoto(d.photo_url);
                                        return (
                                            <div key={d.driver_number} onClick={()=>openDriver(d.driver_number)}
                                                 style={{cursor:'pointer',borderRadius:16,overflow:'hidden',position:'relative',background:'var(--f1-card)',border:'1px solid var(--f1-border)',boxShadow:'0 4px 24px rgba(0,0,0,0.2)',transition:'transform 0.15s'}}>
                                                <div style={{position:'absolute',top:10,right:10,fontSize:42,fontWeight:900,color:d.team_color,opacity:0.2,lineHeight:1,zIndex:1}}>{d.driver_number}</div>
                                                <div style={{width:'100%',height:180,background:`linear-gradient(180deg,${d.team_color}15,${d.team_color}05)`,position:'relative',overflow:'hidden'}}>
                                                    {bigPhoto && <img src={bigPhoto} alt="" style={{width:'100%',height:'100%',objectFit:'cover',objectPosition:'top'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                    <div style={{position:'absolute',bottom:0,left:0,right:0,height:'60%',background:`linear-gradient(transparent,${d.team_color}CC)`}}/>
                                                    <div style={{position:'absolute',bottom:8,left:10,right:10,zIndex:1}}>
                                                        <div style={{fontSize:11,color:'rgba(255,255,255,0.8)'}}>{flagEmoji(d.country)} {d.first_name||d.name?.split(' ')[0]}</div>
                                                        <div style={{fontSize:16,fontWeight:900,color:'#fff',lineHeight:1.2,textShadow:'0 1px 4px rgba(0,0,0,0.5)'}}>{d.last_name||d.name?.split(' ').slice(1).join(' ')}</div>
                                                    </div>
                                                </div>
                                                <div style={{padding:'8px 10px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                                    <div style={{fontSize:11,color:d.team_color,fontWeight:600}}>{d.team?.replace('F1 Team','').trim()}</div>
                                                    {d.points != null && <div style={{background:`${d.team_color}22`,color:d.team_color,padding:'2px 8px',borderRadius:6,fontSize:12,fontWeight:700}}>{d.points} –æ—á–∫.</div>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    {/* TEAMS ‚Äî full team cards */}
                    {tab==='teams' && (
                        <div style={{padding:'0 12px'}}>
                            {!teamsData ? (
                                <div>{[1,2,3,4,5].map(i=><Skeleton key={i} h="200px" r="16px" className="mb-3"/>)}</div>
                            ) : (
                                teamsData.map((team,i)=>(
                                    <div key={i} className="card" style={{marginBottom:12,padding:0,overflow:'hidden'}}>
                                        {team.car_url && (
                                            <div style={{width:'100%',height:140,background:`linear-gradient(135deg,${team.team_color}15,var(--f1-card-solid))`,position:'relative',overflow:'hidden'}}>
                                                <img src={team.car_url} alt="" style={{width:'100%',height:'100%',objectFit:'contain',padding:12}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>
                                            </div>
                                        )}
                                        <div style={{padding:'12px 14px'}}>
                                            <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                                                {team.logo_url && <img src={team.logo_url} alt="" style={{width:28,height:28,objectFit:'contain'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                <div style={{flex:1}}>
                                                    <div style={{fontWeight:700,fontSize:15,color:team.team_color}}>{team.team}</div>
                                                </div>
                                                <div style={{textAlign:'right'}}>
                                                    <div style={{fontWeight:900,fontSize:18,fontVariantNumeric:'tabular-nums'}}>{team.points||'‚Äî'}</div>
                                                    <div style={{fontSize:10,color:'var(--f1-text-muted)'}}>P{team.position||i+1}</div>
                                                </div>
                                            </div>
                                            <div style={{display:'flex',gap:12}}>
                                                {team.drivers?.map((d,j)=>(
                                                    <div key={j} onClick={(e)=>{e.stopPropagation();d.driver_number&&openDriver(d.driver_number);}} style={{display:'flex',alignItems:'center',gap:8,cursor:'pointer',flex:1,padding:'6px 8px',background:'rgba(255,255,255,0.03)',borderRadius:10,border:'1px solid var(--f1-border)'}}>
                                                        {d.photo_url && <img src={d.photo_url} alt="" style={{width:32,height:32,borderRadius:'50%',objectFit:'cover',background:'var(--f1-gray)',border:`2px solid ${team.team_color}`}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                                        <div>
                                                            <div style={{fontWeight:700,fontSize:13}}>{d.code}</div>
                                                            <div style={{fontSize:10,color:'var(--f1-text-muted)'}}>{d.name?.split(' ').pop()}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // ==== PREDICTIONS PAGE ====
        const PredictionsPage = ({user}) => {
            const [available, setAvailable] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selected, setSelected] = useState({});
            const [podiumPicks, setPodiumPicks] = useState([]);
            const [submitting, setSubmitting] = useState(false);
            const [myPredictions, setMyPredictions] = useState([]);
            useEffect(() => { (async()=>{ const [a,p] = await Promise.all([api.get('/api/predictions/available'),api.get('/api/user/predictions')]); setAvailable(a); setMyPredictions(p?.predictions||[]); setLoading(false); })(); }, []);
            const handlePredict = async (type, value) => {
                if (!available?.race?.round) return; setSubmitting(true);
                const result = await api.post('/api/predictions/make',{race_round:available.race.round,season:2025,prediction_type:type,prediction_value:value});
                if (result?.status==='ok') { setSelected(prev=>({...prev,[type]:value})); const p=await api.get('/api/user/predictions'); setMyPredictions(p?.predictions||[]); }
                setSubmitting(false);
            };
            if (loading) return <div className="page-container fade-in" style={{padding:16}}><CardSkeleton/><div style={{height:12}}/><CardSkeleton/></div>;
            return (
                <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                    <h2 style={{fontSize:22,fontWeight:900,marginBottom:4}}>–ü—Ä–æ–≥–Ω–æ–∑—ã</h2>
                    {available?.available && available.race ? (<>
                        <div style={{fontSize:13,color:'var(--f1-text-secondary)',marginBottom:16}}>{flagEmoji(available.race.country)} {available.race.name} ¬∑ –†–∞—É–Ω–¥ {available.race.round}</div>
                        {available.predictions?.map(pred=>(
                            <div key={pred.type} className="card" style={{marginBottom:10}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
                                    <div><div style={{fontWeight:700,fontSize:15}}>{pred.label}</div><div style={{fontSize:12,color:'var(--f1-text-muted)'}}>{pred.description}</div></div>
                                    <div style={{background:'rgba(225,6,0,0.15)',borderRadius:8,padding:'4px 8px',fontSize:12,fontWeight:700,color:'var(--f1-red)'}}>+{pred.max_points}</div>
                                </div>
                                {pred.already_predicted || selected[pred.type] ? (
                                    <div style={{padding:'8px 12px',borderRadius:8,background:'rgba(57,181,74,0.1)',color:'#39B54A',fontSize:13,fontWeight:600}}>‚úì –ü—Ä–æ–≥–Ω–æ–∑ —Å–¥–µ–ª–∞–Ω</div>
                                ) : pred.type==='winner'||pred.type==='fastest_lap' ? (
                                    <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
                                        {available.drivers?.slice(0,20).map(d=>(
                                            <button key={d.driver_number} onClick={()=>handlePredict(pred.type,d.driver_number)} disabled={submitting}
                                                style={{background:`${d.team_color}44`,border:`1px solid ${d.team_color}66`,borderRadius:8,padding:'6px 10px',color:'white',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'inherit',opacity:submitting?0.5:1,transition:'transform 0.1s'}}>{d.code}</button>
                                        ))}
                                    </div>
                                ) : pred.type==='podium' ? (
                                    <div>
                                        <div style={{fontSize:12,color:'var(--f1-text-muted)',marginBottom:6}}>–í—ã–±—Ä–∞–Ω–æ: {podiumPicks.length}/3 {podiumPicks.length===3&&<span style={{color:'#39B54A',marginLeft:8}}>–ì–æ—Ç–æ–≤–æ!</span>}</div>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
                                            {available.drivers?.slice(0,20).map(d=>{
                                                const picked=podiumPicks.includes(d.driver_number), idx=podiumPicks.indexOf(d.driver_number);
                                                return (
                                                    <button key={d.driver_number} onClick={()=>{if(picked)setPodiumPicks(p=>p.filter(n=>n!==d.driver_number));else if(podiumPicks.length<3)setPodiumPicks(p=>[...p,d.driver_number]);}} disabled={submitting}
                                                        style={{background:picked?d.team_color:`${d.team_color}33`,border:`2px solid ${picked?d.team_color:d.team_color+'44'}`,borderRadius:8,padding:'6px 10px',color:'white',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'inherit',opacity:submitting?0.5:(!picked&&podiumPicks.length>=3)?0.3:1}}>
                                                        {picked&&<span style={{marginRight:4}}>{idx+1}.</span>}{d.code}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        {podiumPicks.length===3 && <button className="btn-primary" style={{width:'100%',marginTop:10}} onClick={()=>handlePredict('podium',podiumPicks)} disabled={submitting}>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–∏—É–º</button>}
                                    </div>
                                ) : pred.type==='safety_car' ? (
                                    <div style={{display:'flex',gap:8}}>
                                        <button className="btn-primary" style={{flex:1}} onClick={()=>handlePredict('safety_car','yes')} disabled={submitting}>–î–∞</button>
                                        <button className="btn-primary" style={{flex:1,background:'var(--f1-gray)'}} onClick={()=>handlePredict('safety_car','no')} disabled={submitting}>–ù–µ—Ç</button>
                                    </div>
                                ) : pred.type==='dnf_count' ? (
                                    <div style={{display:'flex',gap:6}}>{[0,1,2,3,4,5].map(n=>(
                                        <button key={n} onClick={()=>handlePredict('dnf_count',n)} disabled={submitting} style={{flex:1,padding:'10px 0',background:'rgba(255,255,255,0.05)',border:'1px solid var(--f1-border)',borderRadius:8,color:'white',fontSize:16,fontWeight:700,cursor:'pointer',fontFamily:'inherit'}}>{n}</button>
                                    ))}</div>
                                ) : null}
                            </div>
                        ))}
                    </>) : (
                        <div style={{textAlign:'center',padding:'40px 20px',color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üîÆ</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div><div style={{fontSize:13}}>–ü—Ä–æ–≥–Ω–æ–∑—ã –æ—Ç–∫—Ä–æ—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –≥–æ–Ω–∫–æ–π</div></div>
                    )}
                    {myPredictions.length>0 && (
                        <div style={{marginTop:20}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>–ú–æ–∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</div>
                            {myPredictions.slice(0,10).map((p,i)=>(
                                <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:'1px solid var(--f1-border)',fontSize:13}}>
                                    <div><span style={{fontWeight:600}}>R{p.race_round}</span><span style={{color:'var(--f1-text-muted)',marginLeft:8}}>{p.prediction_type}</span></div>
                                    <div style={{fontWeight:700,color:p.status==='correct'?'#39B54A':p.status==='partial'?'#FFD700':p.status==='incorrect'?'#E10600':'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>{p.status==='pending'?'‚è≥':p.status==='correct'?`‚úì +${p.points_won}`:p.status==='partial'?`~ +${p.points_won}`:'‚úó'}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // ==== PROFILE PAGE ====
        const ProfilePage = ({user}) => {
            const [leaderboard, setLeaderboard] = useState(null);
            const [achievements, setAchievements] = useState(null);
            useEffect(() => { api.get('/api/leaderboard').then(setLeaderboard); api.get('/api/user/achievements').then(setAchievements); }, []);
            if (!user) return <div className="page-container fade-in" style={{padding:16}}><CardSkeleton/></div>;
            return (
                <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                    <div className="card" style={{textAlign:'center',marginBottom:16,position:'relative',overflow:'hidden'}}>
                        <div style={{position:'absolute',top:0,left:0,right:0,height:60,background:'linear-gradient(180deg,rgba(225,6,0,0.2),transparent)'}}/>
                        {user.photo_url ? (
                            <img src={user.photo_url} alt="" style={{width:64,height:64,borderRadius:'50%',margin:'0 auto 8px',objectFit:'cover',border:'3px solid var(--f1-red)',boxShadow:'0 4px 16px rgba(225,6,0,0.3)'}} onError={e=>{e.target.style.display='none';e.target.nextSibling.style.display='flex';}}/>
                        ) : null}
                        <div style={{width:64,height:64,borderRadius:'50%',margin:'0 auto 8px',background:'linear-gradient(135deg,var(--f1-red),#FF6B00)',alignItems:'center',justifyContent:'center',fontSize:28,fontWeight:900,position:'relative',boxShadow:'0 4px 16px rgba(225,6,0,0.3)',display:user.photo_url?'none':'flex'}}>{user.first_name?.[0]||'?'}</div>
                        <div style={{fontSize:20,fontWeight:900}}>{user.first_name}</div>
                        {user.username && <div style={{fontSize:13,color:'var(--f1-text-muted)'}}>@{user.username}</div>}
                        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginTop:16}}>
                            <div><div style={{fontSize:24,fontWeight:900,color:'var(--f1-red)'}}>{user.points}</div><div style={{fontSize:11,color:'var(--f1-text-muted)'}}>–û—á–∫–∏</div></div>
                            <div><div style={{fontSize:24,fontWeight:900}}>#{user.rank||'‚Äî'}</div><div style={{fontSize:11,color:'var(--f1-text-muted)'}}>–†–µ–π—Ç–∏–Ω–≥</div></div>
                            <div><div style={{fontSize:24,fontWeight:900}}>{user.streak||0}</div><div style={{fontSize:11,color:'var(--f1-text-muted)'}}>üî• –°–µ—Ä–∏—è</div></div>
                        </div>
                    </div>

                    <div className="card" style={{marginBottom:16}}>
                        <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:12}}>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                        {[{label:'–ü—Ä–æ–≥–Ω–æ–∑–æ–≤ —Å–¥–µ–ª–∞–Ω–æ',value:user.predictions_total||0,max:50,color:'var(--f1-red)'},
                          {label:'–ü—Ä–æ–≥–Ω–æ–∑–æ–≤ —É–≥–∞–¥–∞–Ω–æ',value:user.predictions_correct||0,max:user.predictions_total||1,color:'#39B54A'},
                          {label:'–¢–æ—á–Ω–æ—Å—Ç—å',value:user.predictions_total?Math.round(user.predictions_correct/user.predictions_total*100)+'%':'‚Äî'},
                          {label:'–ú–∞–∫—Å. —Å–µ—Ä–∏—è',value:user.max_streak||0},
                          {label:'–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ',value:user.games_played||0,max:50,color:'#6692FF'}
                        ].map((stat,i)=>(
                            <div key={i} style={{padding:'8px 0',borderBottom:i<4?'1px solid var(--f1-border)':'none'}}>
                                <div style={{display:'flex',justifyContent:'space-between',marginBottom:stat.max?4:0}}>
                                    <span style={{color:'var(--f1-text-secondary)',fontSize:14}}>{stat.label}</span>
                                    <span style={{fontWeight:700,fontSize:14,fontVariantNumeric:'tabular-nums'}}>{stat.value}</span>
                                </div>
                                {stat.max && <div className="progress-bar-bg"><div className="progress-bar-fill" style={{width:`${Math.min(100,(typeof stat.value==='number'?stat.value:0)/stat.max*100)}%`,background:stat.color}}/></div>}
                            </div>
                        ))}
                    </div>

                    {achievements && (
                        <div style={{marginBottom:16}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è ({achievements.achievements?.length||0}/{achievements.total||0})</div>
                            <div style={{display:'flex',flexDirection:'column',gap:8}}>
                                {achievements.all_achievements && Object.entries(achievements.all_achievements).map(([key,ach])=>{
                                    const unlocked = achievements.achievements?.some(a=>a.key===key);
                                    return (
                                        <div key={key} className={`achievement-badge ${unlocked?'':'achievement-locked'}`}>
                                            <span className="achievement-icon">{ach.icon}</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:700,fontSize:14}}>{ach.name}</div>
                                                <div style={{fontSize:12,color:'var(--f1-text-muted)'}}>{ach.desc}</div>
                                            </div>
                                            {unlocked && <span style={{fontSize:16}}>‚úÖ</span>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {leaderboard?.leaderboard && (
                        <div>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
                            <div className="card" style={{padding:0,overflow:'hidden'}}>
                                {leaderboard.leaderboard.slice(0,20).map((entry,i)=>(
                                    <div key={entry.user_id} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 16px',borderBottom:'1px solid var(--f1-border)',background:entry.user_id===user.user_id?'rgba(225,6,0,0.08)':'transparent'}}>
                                        <div style={{width:28,fontWeight:900,fontSize:14,color:i<3?['#FFD700','#C0C0C0','#CD7F32'][i]:'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>{entry.rank}</div>
                                        <div style={{width:36,height:36,borderRadius:'50%',background:i<3?`linear-gradient(135deg,${['#FFD700','#C0C0C0','#CD7F32'][i]}33,var(--f1-gray))`:'var(--f1-gray)',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:700,fontSize:14}}>{entry.first_name?.[0]||'?'}</div>
                                        <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14}}>{entry.first_name}</div>{entry.username&&<div style={{fontSize:11,color:'var(--f1-text-muted)'}}>@{entry.username}</div>}</div>
                                        <div style={{fontWeight:900,fontSize:16,fontVariantNumeric:'tabular-nums'}}>{entry.total_points}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==== ANALYTICS PAGE ====
        const AnalyticsPage = () => {
            const [aTab, setATab] = useState('strategy');
            const [strategy, setStrategy] = useState(null);
            const [posChart, setPosChart] = useState(null);
            const [lapTimes, setLapTimes] = useState(null);
            const [degradation, setDegradation] = useState(null);
            const [loading, setLoading] = useState(false);
            const [selectedDrivers, setSelectedDrivers] = useState([]);
            const [degDrivers, setDegDrivers] = useState([]);
            const posChartRef = useRef(null);
            const lapChartRef = useRef(null);
            const degChartRef = useRef(null);
            const posChartInstance = useRef(null);
            const lapChartInstance = useRef(null);
            const degChartInstance = useRef(null);

            // Telemetry state
            const [telDriver1, setTelDriver1] = useState(null);
            const [telDriver2, setTelDriver2] = useState(null);
            const [telData, setTelData] = useState(null);
            const [telLoading, setTelLoading] = useState(false);
            const [telDriverList, setTelDriverList] = useState([]);
            const telSpeedRef = useRef(null);
            const telSpeedInstance = useRef(null);

            // Strategy prediction state
            const [stratPred, setStratPred] = useState(null);

            // Weather radar state
            const [weatherRadar, setWeatherRadar] = useState(null);
            const [radarFrame, setRadarFrame] = useState(0);
            const radarIntervalRef = useRef(null);

            const tyreColors = {SOFT:'#FF3333',MEDIUM:'#FFD700',HARD:'#CCCCCC',INTERMEDIATE:'#39B54A',WET:'#0067FF',UNKNOWN:'#888888'};
            const tyreLabels = {SOFT:'–°–æ—Ñ—Ç',MEDIUM:'–ú–µ–¥–∏—É–º',HARD:'–•–∞—Ä–¥'};

            useEffect(() => {
                setLoading(true);
                if (aTab === 'strategy' && !strategy) {
                    api.get('/api/analytics/strategy').then(d => { setStrategy(d); setLoading(false); });
                } else if (aTab === 'positions' && !posChart) {
                    api.get('/api/analytics/positions').then(d => { setPosChart(d); setLoading(false); });
                } else if (aTab === 'laptimes' && !lapTimes) {
                    api.get('/api/analytics/laptimes').then(d => {
                        setLapTimes(d);
                        if (d?.drivers?.length > 0) setSelectedDrivers(d.drivers.slice(0, 3).map(dr => dr.driver_number));
                        setLoading(false);
                    });
                } else if (aTab === 'degradation' && !degradation) {
                    api.get('/api/analytics/degradation').then(d => {
                        setDegradation(d);
                        if (d?.drivers?.length > 0) setDegDrivers(d.drivers.slice(0, 3).map(dr => dr.driver_number));
                        setLoading(false);
                    });
                } else if (aTab === 'telemetry' && !telDriverList.length) {
                    api.get('/api/analytics/laptimes').then(d => {
                        if (d?.drivers?.length > 0) {
                            setTelDriverList(d.drivers);
                            setTelDriver1(d.drivers[0]?.driver_number);
                            setTelDriver2(d.drivers[1]?.driver_number);
                        }
                        setLoading(false);
                    });
                } else if (aTab === 'stratpred' && !stratPred) {
                    api.get('/api/analytics/strategy-prediction').then(d => { setStratPred(d); setLoading(false); });
                } else if (aTab === 'weather' && !weatherRadar) {
                    api.get('/api/analytics/weather-radar').then(d => { setWeatherRadar(d); setLoading(false); });
                } else setLoading(false);
            }, [aTab]);

            // Position chart rendering
            useEffect(() => {
                if (aTab !== 'positions' || !posChart?.drivers?.length || !posChartRef.current) return;
                if (posChartInstance.current) posChartInstance.current.destroy();
                const ctx = posChartRef.current.getContext('2d');
                const datasets = posChart.drivers.map(d => ({
                    label: d.code || d.name,
                    data: d.positions.map(p => ({x: p.lap, y: p.position})),
                    borderColor: d.team_color || '#888',
                    backgroundColor: d.team_color || '#888',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.1,
                    fill: false,
                }));
                posChartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {datasets},
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                mode: 'nearest', intersect: false,
                                backgroundColor: '#1E1E2C', titleColor: '#fff', bodyColor: '#9A9AAF',
                                borderColor: '#38383F', borderWidth: 1,
                                callbacks: {
                                    title: (items) => items[0]?.dataset?.label || '',
                                    label: (item) => `–ö—Ä—É–≥ ${item.parsed.x}: P${item.parsed.y}`,
                                }
                            },
                        },
                        scales: {
                            x: {type:'linear', title:{display:true,text:'–ö—Ä—É–≥',color:'#6B6B80',font:{family:'Titillium Web'}}, ticks:{color:'#6B6B80'}, grid:{color:'#38383F33'}},
                            y: {reverse:true, title:{display:true,text:'–ü–æ–∑–∏—Ü–∏—è',color:'#6B6B80',font:{family:'Titillium Web'}}, ticks:{color:'#6B6B80',stepSize:1}, grid:{color:'#38383F33'}, min:1, max:20},
                        },
                        interaction: {mode:'nearest',axis:'x',intersect:false},
                    },
                });
                return () => { if (posChartInstance.current) posChartInstance.current.destroy(); };
            }, [posChart, aTab]);

            // Lap times chart rendering
            useEffect(() => {
                if (aTab !== 'laptimes' || !lapTimes?.drivers?.length || !lapChartRef.current || !selectedDrivers.length) return;
                if (lapChartInstance.current) lapChartInstance.current.destroy();
                const ctx = lapChartRef.current.getContext('2d');
                const filtered = lapTimes.drivers.filter(d => selectedDrivers.includes(d.driver_number));
                const datasets = filtered.map(d => ({
                    label: d.code || d.name,
                    data: d.laps.filter(l => l.time && !l.is_pit_out).map(l => ({x: l.lap, y: l.time})),
                    borderColor: d.team_color || '#888',
                    backgroundColor: (context) => {
                        const idx = context.dataIndex;
                        const lap = d.laps.filter(l => l.time && !l.is_pit_out)[idx];
                        return lap ? (tyreColors[lap.compound] || '#888') : d.team_color;
                    },
                    borderWidth: 1.5,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0,
                    fill: false,
                    showLine: true,
                }));
                // Calculate y axis range (exclude outlier laps)
                const allTimes = datasets.flatMap(ds => ds.data.map(p => p.y)).filter(Boolean);
                const medianTime = allTimes.sort((a,b) => a-b)[Math.floor(allTimes.length/2)] || 90;
                const yMin = Math.max(0, medianTime * 0.95);
                const yMax = medianTime * 1.12;

                lapChartInstance.current = new Chart(ctx, {
                    type: 'scatter',
                    data: {datasets},
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                backgroundColor: '#1E1E2C', titleColor: '#fff', bodyColor: '#9A9AAF',
                                borderColor: '#38383F', borderWidth: 1,
                                callbacks: {
                                    title: (items) => items[0]?.dataset?.label || '',
                                    label: (item) => {
                                        const t = item.parsed.y;
                                        const m = Math.floor(t/60);
                                        const s = (t%60).toFixed(3);
                                        return `–ö—Ä—É–≥ ${item.parsed.x}: ${m>0?m+':'+s.padStart(6,'0'):s}`;
                                    },
                                }
                            },
                        },
                        scales: {
                            x: {type:'linear', title:{display:true,text:'–ö—Ä—É–≥',color:'#6B6B80',font:{family:'Titillium Web'}}, ticks:{color:'#6B6B80'}, grid:{color:'#38383F33'}},
                            y: {title:{display:true,text:'–í—Ä–µ–º—è (—Å–µ–∫)',color:'#6B6B80',font:{family:'Titillium Web'}}, ticks:{color:'#6B6B80',callback:v=>{const m=Math.floor(v/60);const s=(v%60).toFixed(1);return m>0?m+':'+s.padStart(4,'0'):s;}}, grid:{color:'#38383F33'}, min:yMin, max:yMax},
                        },
                        interaction: {mode:'nearest',intersect:false},
                    },
                });
                return () => { if (lapChartInstance.current) lapChartInstance.current.destroy(); };
            }, [lapTimes, aTab, selectedDrivers]);

            // Degradation chart rendering
            useEffect(() => {
                if (aTab !== 'degradation' || !degradation?.drivers?.length || !degChartRef.current || !degDrivers.length) return;
                if (degChartInstance.current) degChartInstance.current.destroy();
                const ctx = degChartRef.current.getContext('2d');
                const filtered = degradation.drivers.filter(d => degDrivers.includes(d.driver_number));
                const datasets = [];
                filtered.forEach(d => {
                    d.stints.forEach((stint, si) => {
                        // Scatter points colored by compound
                        datasets.push({
                            label: `${d.code} S${stint.stint_number} (${stint.compound})`,
                            data: stint.laps.map(l => ({x: l.lap, y: l.corrected_time})),
                            backgroundColor: tyreColors[stint.compound] || '#888',
                            borderColor: 'transparent',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: false,
                            type: 'scatter',
                        });
                        // Trend line
                        if (stint.trend_line?.length === 2) {
                            datasets.push({
                                label: `${d.code} trend S${stint.stint_number}`,
                                data: stint.trend_line.map(t => ({x: t.lap, y: t.time})),
                                borderColor: d.team_color || '#888',
                                borderWidth: 1.5,
                                borderDash: [6, 3],
                                pointRadius: 0,
                                showLine: true,
                                fill: false,
                                type: 'scatter',
                            });
                        }
                    });
                });
                const allTimes = datasets.flatMap(ds => ds.data.map(p => p.y)).filter(Boolean);
                const medTime = allTimes.sort((a,b) => a-b)[Math.floor(allTimes.length/2)] || 90;
                const yMin = Math.max(0, medTime * 0.97);
                const yMax = medTime * 1.06;
                degChartInstance.current = new Chart(ctx, {
                    type: 'scatter',
                    data: {datasets},
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                backgroundColor: '#1E1E2C', titleColor: '#fff', bodyColor: '#9A9AAF',
                                borderColor: '#38383F', borderWidth: 1,
                                filter: (item) => !item.dataset.label?.includes('trend'),
                                callbacks: {
                                    title: (items) => items[0]?.dataset?.label || '',
                                    label: (item) => {
                                        const t = item.parsed.y;
                                        const m = Math.floor(t/60), s = (t%60).toFixed(3);
                                        return `–ö—Ä—É–≥ ${item.parsed.x}: ${m>0?m+':'+s.padStart(6,'0'):s}`;
                                    },
                                }
                            },
                        },
                        scales: {
                            x: {type:'linear',title:{display:true,text:'–ö—Ä—É–≥',color:'#6B6B80',font:{family:'Titillium Web'}},ticks:{color:'#6B6B80'},grid:{color:'#38383F33'}},
                            y: {title:{display:true,text:'–í—Ä–µ–º—è (—Å–∫–æ—Ä—Ä.)',color:'#6B6B80',font:{family:'Titillium Web'}},ticks:{color:'#6B6B80',callback:v=>{const m=Math.floor(v/60);const s=(v%60).toFixed(1);return m>0?m+':'+s.padStart(4,'0'):s;}},grid:{color:'#38383F33'},min:yMin,max:yMax},
                        },
                        interaction: {mode:'nearest',intersect:false},
                    },
                });
                return () => { if (degChartInstance.current) degChartInstance.current.destroy(); };
            }, [degradation, aTab, degDrivers]);

            const toggleDriver = (dn) => {
                setSelectedDrivers(prev => prev.includes(dn) ? prev.filter(n => n !== dn) : [...prev, dn].slice(-5));
            };
            const toggleDegDriver = (dn) => {
                setDegDrivers(prev => prev.includes(dn) ? prev.filter(n => n !== dn) : [...prev, dn].slice(-5));
            };

            // Telemetry comparison handler
            const compareTelemetry = () => {
                if (!telDriver1 || !telDriver2 || telDriver1 === telDriver2) return;
                setTelLoading(true); setTelData(null);
                api.get(`/api/analytics/telemetry?driver1=${telDriver1}&driver2=${telDriver2}`).then(d => { setTelData(d); setTelLoading(false); });
            };

            // Telemetry speed chart
            useEffect(() => {
                if (aTab !== 'telemetry' || !telData?.driver1?.telemetry?.length || !telSpeedRef.current) return;
                if (telSpeedInstance.current) telSpeedInstance.current.destroy();
                const ctx = telSpeedRef.current.getContext('2d');
                const d1 = telData.driver1, d2 = telData.driver2;
                telSpeedInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {label:d1.code, data:d1.telemetry.map(t=>({x:t.pct,y:t.speed})), borderColor:d1.team_color||'#FF3333', borderWidth:1.5, pointRadius:0, tension:0.1},
                            {label:d2.code, data:d2.telemetry.map(t=>({x:t.pct,y:t.speed})), borderColor:d2.team_color||'#0077FF', borderWidth:1.5, pointRadius:0, tension:0.1},
                        ],
                    },
                    options: {
                        responsive:true, maintainAspectRatio:false,
                        plugins: {legend:{display:true,labels:{color:'#9A9AAF',boxWidth:12,font:{size:10,family:'Titillium Web'}}}, tooltip:{backgroundColor:'#1E1E2C',titleColor:'#fff',bodyColor:'#9A9AAF',borderColor:'#38383F',borderWidth:1}},
                        scales: {
                            x: {type:'linear',title:{display:true,text:'–î–∏—Å—Ç–∞–Ω—Ü–∏—è %',color:'#6B6B80',font:{family:'Titillium Web',size:10}},ticks:{color:'#6B6B80',font:{size:9}},grid:{color:'#38383F33'},min:0,max:100},
                            y: {title:{display:true,text:'–°–∫–æ—Ä–æ—Å—Ç—å –∫–º/—á',color:'#6B6B80',font:{family:'Titillium Web',size:10}},ticks:{color:'#6B6B80',font:{size:9}},grid:{color:'#38383F33'}},
                        },
                        interaction:{mode:'index',intersect:false},
                    },
                });
                return () => { if (telSpeedInstance.current) telSpeedInstance.current.destroy(); };
            }, [telData, aTab]);

            // Weather radar animation
            useEffect(() => {
                if (aTab !== 'weather' || !weatherRadar?.frames?.length) { if(radarIntervalRef.current) clearInterval(radarIntervalRef.current); return; }
                radarIntervalRef.current = setInterval(() => {
                    setRadarFrame(prev => (prev + 1) % weatherRadar.frames.length);
                }, 1200);
                return () => { if(radarIntervalRef.current) clearInterval(radarIntervalRef.current); };
            }, [aTab, weatherRadar]);

            return (
                <div className="page-container fade-in" style={{padding:'12px 0'}}>
                    <div style={{padding:'0 16px'}}>
                        <h2 style={{fontSize:22,fontWeight:900,marginBottom:12}}>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                        <div style={{display:'flex',gap:4,marginBottom:16,overflowX:'auto',paddingBottom:4}}>
                            {[{id:'strategy',label:'–®–∏–Ω—ã'},{id:'positions',label:'–ü–æ–∑–∏—Ü–∏–∏'},{id:'laptimes',label:'–¢–µ–º–ø—ã'},{id:'degradation',label:'–î–µ–≥—Ä–∞–¥.'},{id:'telemetry',label:'–¢–µ–ª–µ–º–µ—Ç.'},{id:'stratpred',label:'–°—Ç—Ä–∞—Ç–µ–≥–∏—è'},{id:'weather',label:'–ü–æ–≥–æ–¥–∞'}].map(t=>(
                                <button key={t.id} className={`tab-switch-btn ${aTab===t.id?'active':''}`} onClick={()=>setATab(t.id)} style={{fontSize:11,padding:'6px 10px',whiteSpace:'nowrap',flexShrink:0}}>{t.label}</button>
                            ))}
                        </div>
                    </div>

                    {loading && <div style={{padding:16}}><CardSkeleton/><div style={{height:12}}/><CardSkeleton/></div>}

                    {/* TYRE STRATEGY */}
                    {aTab==='strategy' && !loading && (strategy?.drivers?.length > 0 ? (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:4,paddingLeft:4}}>–°—Ç—Ä–∞—Ç–µ–≥–∏—è —à–∏–Ω ¬∑ {strategy.total_laps} –∫—Ä—É–≥–æ–≤</div>
                            <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap',paddingLeft:4}}>
                                {['SOFT','MEDIUM','HARD','INTERMEDIATE','WET'].map(c=>(
                                    <div key={c} style={{display:'flex',alignItems:'center',gap:4,fontSize:11}}>
                                        <span style={{width:10,height:10,borderRadius:'50%',background:tyreColors[c],display:'inline-block'}}/>{c}
                                    </div>
                                ))}
                            </div>
                            {strategy.drivers.map((d,i)=>(
                                <div key={d.driver_number} style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,padding:'4px 0'}}>
                                    <div style={{width:30,fontSize:11,fontWeight:700,color:d.team_color,textAlign:'right',flexShrink:0}}>{d.code}</div>
                                    <div style={{flex:1,display:'flex',height:22,borderRadius:4,overflow:'hidden',background:'var(--f1-gray)',gap:1}}>
                                        {d.stints.map((s,j)=>{
                                            const lapStart = s.lap_start || 1;
                                            const lapEnd = s.lap_end || strategy.total_laps;
                                            const widthPct = ((lapEnd - lapStart + 1) / strategy.total_laps) * 100;
                                            return (
                                                <div key={j} style={{width:`${widthPct}%`,background:tyreColors[s.compound]||'#888',minWidth:2,display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:700,color:s.compound==='HARD'||s.compound==='MEDIUM'?'#000':'#fff',overflow:'hidden',whiteSpace:'nowrap'}}>
                                                    {widthPct>8?`${lapEnd-lapStart+1}L`:''}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div style={{width:20,fontSize:10,color:'var(--f1-text-muted)',textAlign:'center',flexShrink:0}}>P{d.finish_position}</div>
                                </div>
                            ))}
                        </div>
                    ) : !loading && (
                        <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üèéÔ∏è</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ –≥–æ–Ω–∫–∏</div></div>
                    ))}

                    {/* POSITION CHART */}
                    {aTab==='positions' && !loading && (posChart?.drivers?.length > 0 ? (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–æ –∫—Ä—É–≥–∞–º</div>
                            <div style={{display:'flex',flexWrap:'wrap',gap:4,marginBottom:8,paddingLeft:4}}>
                                {posChart.drivers.map(d=>(
                                    <div key={d.driver_number} style={{display:'flex',alignItems:'center',gap:3,fontSize:10,padding:'2px 6px',borderRadius:4,background:`${d.team_color}22`,color:d.team_color,fontWeight:600}}>
                                        <span style={{width:6,height:6,borderRadius:'50%',background:d.team_color}}/>{d.code}
                                    </div>
                                ))}
                            </div>
                            <div className="card" style={{padding:8,height:350}}>
                                <canvas ref={posChartRef}/>
                            </div>
                        </div>
                    ) : !loading && (
                        <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üìà</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div><div style={{fontSize:13}}>–ì—Ä–∞—Ñ–∏–∫ –ø–æ—è–≤–∏—Ç—Å—è –≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ —Å–µ—Å—Å–∏–∏</div></div>
                    ))}

                    {/* LAP TIMES */}
                    {aTab==='laptimes' && !loading && (lapTimes?.drivers?.length > 0 ? (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–º–ø–∞ ¬∑ –í—ã–±–µ—Ä–∏ –ø–∏–ª–æ—Ç–æ–≤</div>
                            <div style={{display:'flex',flexWrap:'wrap',gap:4,marginBottom:10,paddingLeft:4}}>
                                {lapTimes.drivers.map(d=>{
                                    const sel = selectedDrivers.includes(d.driver_number);
                                    return (
                                        <button key={d.driver_number} onClick={()=>toggleDriver(d.driver_number)}
                                            style={{display:'flex',alignItems:'center',gap:3,fontSize:11,padding:'4px 8px',borderRadius:6,border:`1.5px solid ${sel?d.team_color:d.team_color+'44'}`,background:sel?`${d.team_color}33`:'transparent',color:sel?'#fff':'var(--f1-text-muted)',fontWeight:600,cursor:'pointer',fontFamily:'inherit',transition:'all 0.15s'}}>
                                            {d.code}
                                        </button>
                                    );
                                })}
                            </div>
                            {lapTimes.session_best && (
                                <div style={{fontSize:12,color:'#A020F0',fontWeight:600,paddingLeft:4,marginBottom:8}}>–õ—É—á—à–∏–π –∫—Ä—É–≥: {fmtLap(lapTimes.session_best)}</div>
                            )}
                            <div className="card" style={{padding:8,height:350}}>
                                <canvas ref={lapChartRef}/>
                            </div>
                        </div>
                    ) : !loading && (
                        <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>‚è±Ô∏è</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—Ä—É–≥–∞—Ö</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ —Å–µ—Å—Å–∏–∏</div></div>
                    ))}

                    {/* TYRE DEGRADATION */}
                    {aTab==='degradation' && !loading && (degradation?.drivers?.length > 0 ? (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>–î–µ–≥—Ä–∞–¥–∞—Ü–∏—è —à–∏–Ω ¬∑ –í—ã–±–µ—Ä–∏ –ø–∏–ª–æ—Ç–æ–≤</div>
                            <div style={{display:'flex',flexWrap:'wrap',gap:4,marginBottom:10,paddingLeft:4}}>
                                {degradation.drivers.map(d=>{
                                    const sel = degDrivers.includes(d.driver_number);
                                    return (
                                        <button key={d.driver_number} onClick={()=>toggleDegDriver(d.driver_number)}
                                            style={{display:'flex',alignItems:'center',gap:3,fontSize:11,padding:'4px 8px',borderRadius:6,border:`1.5px solid ${sel?d.team_color:d.team_color+'44'}`,background:sel?`${d.team_color}33`:'transparent',color:sel?'#fff':'var(--f1-text-muted)',fontWeight:600,cursor:'pointer',fontFamily:'inherit',transition:'all 0.15s'}}>
                                            {d.code}
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Deg rate cards */}
                            <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:12,paddingLeft:4}}>
                                {degradation.drivers.filter(d=>degDrivers.includes(d.driver_number)).map(d=>(
                                    d.stints.map((stint,si)=>{
                                        const rate = stint.deg_rate;
                                        const color = rate===null?'var(--f1-text-muted)':rate<=0.02?'#39B54A':rate<=0.05?'#FFD700':'#FF3333';
                                        return (
                                            <div key={`${d.driver_number}-${si}`} style={{background:'var(--f1-card-solid)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'6px 10px',minWidth:80}}>
                                                <div style={{display:'flex',alignItems:'center',gap:4,marginBottom:2}}>
                                                    <span style={{width:8,height:8,borderRadius:'50%',background:tyreColors[stint.compound]||'#888'}}/>
                                                    <span style={{fontSize:11,fontWeight:700,color:d.team_color}}>{d.code}</span>
                                                    <span style={{fontSize:9,color:'var(--f1-text-muted)'}}>S{stint.stint_number}</span>
                                                </div>
                                                <div style={{fontSize:16,fontWeight:900,color,fontVariantNumeric:'tabular-nums'}}>{rate!==null?`${rate>0?'+':''}${rate.toFixed(3)}`:'-'}</div>
                                                <div style={{fontSize:9,color:'var(--f1-text-muted)'}}>—Å/–∫—Ä—É–≥</div>
                                            </div>
                                        );
                                    })
                                ))}
                            </div>

                            {/* Legend */}
                            <div style={{display:'flex',gap:8,marginBottom:8,paddingLeft:4,fontSize:10,color:'var(--f1-text-muted)'}}>
                                <span><span style={{color:'#39B54A',fontWeight:700}}>‚óè</span> ‚â§0.02 –æ—Ç–ª.</span>
                                <span><span style={{color:'#FFD700',fontWeight:700}}>‚óè</span> ‚â§0.05 –Ω–æ—Ä–º.</span>
                                <span><span style={{color:'#FF3333',fontWeight:700}}>‚óè</span> &gt;0.05 –≤—ã—Å.</span>
                                <span style={{marginLeft:8}}>--- —Ç—Ä–µ–Ω–¥</span>
                            </div>

                            <div className="card" style={{padding:8,height:350}}>
                                <canvas ref={degChartRef}/>
                            </div>
                        </div>
                    ) : !loading && (
                        <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üìâ</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ –≥–æ–Ω–∫–∏</div></div>
                    ))}

                    {/* TELEMETRY COMPARISON */}
                    {aTab==='telemetry' && !loading && (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ ¬∑ –õ—É—á—à–∏–π –∫—Ä—É–≥</div>
                            {telDriverList.length > 0 ? (
                                <div>
                                    <div style={{display:'flex',gap:8,marginBottom:12,alignItems:'center',flexWrap:'wrap',paddingLeft:4}}>
                                        <select value={telDriver1||''} onChange={e=>setTelDriver1(Number(e.target.value))} style={{background:'var(--f1-card-solid)',color:'var(--f1-text)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'6px 10px',fontSize:12,fontFamily:'inherit',fontWeight:600}}>
                                            {telDriverList.map(d=><option key={d.driver_number} value={d.driver_number}>{d.code} ‚Äî {d.name}</option>)}
                                        </select>
                                        <span style={{fontSize:13,fontWeight:700,color:'var(--f1-text-muted)'}}>vs</span>
                                        <select value={telDriver2||''} onChange={e=>setTelDriver2(Number(e.target.value))} style={{background:'var(--f1-card-solid)',color:'var(--f1-text)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'6px 10px',fontSize:12,fontFamily:'inherit',fontWeight:600}}>
                                            {telDriverList.map(d=><option key={d.driver_number} value={d.driver_number}>{d.code} ‚Äî {d.name}</option>)}
                                        </select>
                                        <button onClick={compareTelemetry} disabled={telLoading||!telDriver1||!telDriver2||telDriver1===telDriver2} style={{background:'var(--f1-red)',color:'#fff',border:'none',borderRadius:8,padding:'6px 14px',fontSize:12,fontWeight:700,cursor:'pointer',fontFamily:'inherit',opacity:telLoading?0.5:1}}>{telLoading?'–ó–∞–≥—Ä—É–∑–∫–∞...':'–°—Ä–∞–≤–Ω–∏—Ç—å'}</button>
                                    </div>

                                    {telData?.error && <div className="card" style={{padding:16,textAlign:'center',color:'var(--f1-text-muted)',fontSize:13}}>{telData.error==='no_lap_data'?'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—Ä—É–≥–∞—Ö':telData.error==='no_car_data'?'–ù–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏':'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</div>}

                                    {telData?.driver1 && telData?.driver2 && (
                                        <div>
                                            {/* Lap time cards */}
                                            <div style={{display:'flex',gap:8,marginBottom:12}}>
                                                {[telData.driver1, telData.driver2].map((d,i)=>(
                                                    <div key={i} className="card" style={{flex:1,padding:'10px 12px',borderLeft:`3px solid ${d.team_color}`}}>
                                                        <div style={{fontSize:11,fontWeight:700,color:d.team_color}}>{d.code}</div>
                                                        <div style={{fontSize:20,fontWeight:900,fontVariantNumeric:'tabular-nums'}}>{fmtLap(d.best_lap)}</div>
                                                        <div style={{fontSize:10,color:'var(--f1-text-muted)'}}>–ö—Ä—É–≥ {d.lap_number}</div>
                                                        {d.sectors && <div style={{display:'flex',gap:4,marginTop:4}}>{d.sectors.map((s,si)=><span key={si} style={{fontSize:9,color:'var(--f1-text-muted)',background:'rgba(255,255,255,0.05)',padding:'1px 4px',borderRadius:3}}>S{si+1}: {s?s.toFixed(3):'-'}</span>)}</div>}
                                                    </div>
                                                ))}
                                            </div>
                                            {/* Delta badge */}
                                            <div style={{textAlign:'center',marginBottom:12}}>
                                                <span style={{background:telData.delta>0?`${telData.driver2.team_color}33`:`${telData.driver1.team_color}33`,color:telData.delta>0?telData.driver2.team_color:telData.driver1.team_color,padding:'4px 12px',borderRadius:20,fontSize:13,fontWeight:900,fontVariantNumeric:'tabular-nums'}}>
                                                    {telData.delta>0?'+':''}{telData.delta.toFixed(3)}—Å {telData.delta>0?telData.driver2.code:telData.driver1.code} –±—ã—Å—Ç—Ä–µ–µ
                                                </span>
                                            </div>
                                            {/* Speed chart */}
                                            {(telData.driver1.telemetry?.length>0 || telData.driver2.telemetry?.length>0) && (
                                                <div>
                                                    <div style={{fontSize:10,color:'var(--f1-text-muted)',fontWeight:700,marginBottom:4,paddingLeft:4}}>–°–ö–û–†–û–°–¢–¨ (–∫–º/—á)</div>
                                                    <div className="card" style={{padding:8,height:200,marginBottom:8}}>
                                                        <canvas ref={telSpeedRef}/>
                                                    </div>
                                                </div>
                                            )}
                                            {/* Throttle/Brake bars */}
                                            {telData.driver1.telemetry?.length>0 && (
                                                <div>
                                                    <div style={{fontSize:10,color:'var(--f1-text-muted)',fontWeight:700,marginBottom:4,paddingLeft:4}}>–ì–ê–ó / –¢–û–†–ú–û–ó</div>
                                                    {[telData.driver1, telData.driver2].map((d,di)=>(
                                                        <div key={di} style={{marginBottom:6}}>
                                                            <div style={{fontSize:9,fontWeight:700,color:d.team_color,marginBottom:2,paddingLeft:4}}>{d.code}</div>
                                                            <div style={{display:'flex',height:12,borderRadius:3,overflow:'hidden',background:'rgba(0,0,0,0.3)'}}>
                                                                {_downsample(d.telemetry,80).map((t,i)=>(
                                                                    <div key={i} style={{flex:1,background:t.brake>0?'#FF3333':t.throttle>50?`rgba(57,181,74,${t.throttle/100})`:'rgba(255,255,255,0.05)'}}/>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    <div style={{display:'flex',gap:10,fontSize:9,color:'var(--f1-text-muted)',paddingLeft:4,marginTop:4,marginBottom:8}}>
                                                        <span><span style={{color:'#39B54A'}}>‚ñ†</span> –ì–∞–∑</span>
                                                        <span><span style={{color:'#FF3333'}}>‚ñ†</span> –¢–æ—Ä–º–æ–∑</span>
                                                    </div>
                                                </div>
                                            )}
                                            {/* Gear comparison */}
                                            {telData.driver1.telemetry?.length>0 && (
                                                <div>
                                                    <div style={{fontSize:10,color:'var(--f1-text-muted)',fontWeight:700,marginBottom:4,paddingLeft:4}}>–ü–ï–†–ï–î–ê–ß–ò</div>
                                                    {[telData.driver1, telData.driver2].map((d,di)=>(
                                                        <div key={di} style={{marginBottom:4}}>
                                                            <div style={{fontSize:9,fontWeight:700,color:d.team_color,marginBottom:1,paddingLeft:4}}>{d.code}</div>
                                                            <div style={{display:'flex',height:16,borderRadius:3,overflow:'hidden',background:'rgba(0,0,0,0.3)'}}>
                                                                {_downsample(d.telemetry,80).map((t,i)=>{
                                                                    const gearColors = ['#333','#2D5BA0','#3D7AC0','#4DA3FF','#66B2FF','#99CCFF','#CCE5FF','#E6F0FF','#FFF'];
                                                                    return <div key={i} style={{flex:1,background:gearColors[t.gear]||'#333',display:'flex',alignItems:'center',justifyContent:'center',fontSize:6,color:'#fff',fontWeight:700}}>{t.gear||''}</div>;
                                                                })}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üìä</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–æ–≤</div></div>}
                        </div>
                    )}

                    {/* STRATEGY PREDICTION */}
                    {aTab==='stratpred' && !loading && (stratPred?.strategies?.length > 0 ? (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>AI –°—Ç—Ä–∞—Ç–µ–≥–∏—è ¬∑ {stratPred.total_laps} –∫—Ä—É–≥–æ–≤</div>
                            {/* Info cards */}
                            <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap',paddingLeft:4}}>
                                <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'4px 10px',fontSize:10}}>
                                    <span style={{color:'var(--f1-text-muted)'}}>–ü–∏—Ç-—Å—Ç–æ–ø: </span><span style={{fontWeight:700}}>{stratPred.pit_loss}—Å</span>
                                </div>
                                {Object.entries(stratPred.wear_rates||{}).map(([c,r])=>(
                                    <div key={c} style={{background:'rgba(255,255,255,0.04)',border:'1px solid var(--f1-border)',borderRadius:8,padding:'4px 10px',fontSize:10,display:'flex',alignItems:'center',gap:4}}>
                                        <span style={{width:8,height:8,borderRadius:'50%',background:tyreColors[c]||'#888',display:'inline-block'}}/><span style={{fontWeight:700}}>{r.toFixed(3)}—Å/–∫—Ä</span>
                                    </div>
                                ))}
                            </div>
                            {/* Strategy cards */}
                            {stratPred.strategies.map((s,i)=>(
                                <div key={i} className="card" style={{padding:'12px',marginBottom:8,border:s.optimal?'1.5px solid var(--f1-red)':'1px solid var(--f1-border)'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
                                        <div style={{display:'flex',alignItems:'center',gap:6}}>
                                            {s.optimal && <span style={{background:'var(--f1-red)',color:'#fff',fontSize:9,fontWeight:800,padding:'2px 6px',borderRadius:4}}>–õ–£–ß–®–ê–Ø</span>}
                                            <span style={{fontSize:12,fontWeight:700}}>{s.stops === 1 ? '1 –ø–∏—Ç-—Å—Ç–æ–ø' : '2 –ø–∏—Ç-—Å—Ç–æ–ø–∞'}</span>
                                        </div>
                                        <span style={{fontSize:12,fontWeight:700,color:s.optimal?'var(--f1-red)':'var(--f1-text-muted)',fontVariantNumeric:'tabular-nums'}}>
                                            {s.optimal ? '–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è' : `+${s.delta}—Å`}
                                        </span>
                                    </div>
                                    {/* Strategy bar */}
                                    <div style={{display:'flex',height:32,borderRadius:8,overflow:'hidden',gap:2,marginBottom:6}}>
                                        {s.stints.map((st,j)=>{
                                            const w = (st.laps / stratPred.total_laps) * 100;
                                            const isDark = st.compound==='HARD'||st.compound==='MEDIUM';
                                            return <div key={j} style={{width:`${w}%`,background:tyreColors[st.compound]||'#888',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:isDark?'#000':'#fff',minWidth:20}}>
                                                {w>15?`${st.compound[0]} L${st.start}-${st.end}`:`${st.compound[0]}`}
                                            </div>;
                                        })}
                                    </div>
                                    <div style={{display:'flex',gap:12,fontSize:10,color:'var(--f1-text-muted)'}}>
                                        {s.stints.map((st,j)=><span key={j}><span style={{color:tyreColors[st.compound]}}>‚óè</span> {tyreLabels[st.compound]||st.compound}: {st.laps} –∫—Ä.</span>)}
                                        <span style={{marginLeft:'auto'}}>–ü–∏—Ç: {s.pit_laps.map(p=>`L${p}`).join(', ')}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : !loading && (
                        <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üß†</div><div style={{fontSize:15,fontWeight:700}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div><div style={{fontSize:13}}>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ –≥–æ–Ω–∫–∏</div></div>
                    ))}

                    {/* WEATHER RADAR */}
                    {aTab==='weather' && !loading && (
                        <div style={{padding:'0 12px'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8,paddingLeft:4}}>–†–∞–¥–∞—Ä –æ—Å–∞–¥–∫–æ–≤ ¬∑ {weatherRadar?.circuit || '–¢—Ä–∞—Å—Å–∞'}</div>
                            {weatherRadar?.error ? (
                                <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üå§Ô∏è</div><div style={{fontSize:15,fontWeight:700}}>{weatherRadar.error==='no_coordinates'?'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç—Ä–∞—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã':'–†–∞–¥–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</div></div>
                            ) : weatherRadar ? (
                                <div>
                                    {/* Rain probability card */}
                                    <div className="card" style={{padding:'14px 16px',marginBottom:12,display:'flex',alignItems:'center',gap:12}}>
                                        <div style={{fontSize:36}}>
                                            {weatherRadar.rain_probability==='raining'?'‚òî':weatherRadar.rain_probability==='high'?'üåßÔ∏è':weatherRadar.rain_probability==='medium'?'üå¶Ô∏è':'‚òÄÔ∏è'}
                                        </div>
                                        <div style={{flex:1}}>
                                            <div style={{fontSize:15,fontWeight:700}}>
                                                {{low:'–î–æ–∂–¥—å –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–µ–Ω',medium:'–í–æ–∑–º–æ–∂–µ–Ω –¥–æ–∂–¥—å',high:'–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ–∂–¥—è',raining:'–ò–¥—ë—Ç –¥–æ–∂–¥—å'}[weatherRadar.rain_probability]}
                                            </div>
                                            <div style={{display:'flex',gap:12,fontSize:12,color:'var(--f1-text-muted)',marginTop:4}}>
                                                {weatherRadar.weather.temperature!=null && <span>üå° {weatherRadar.weather.temperature}¬∞C</span>}
                                                {weatherRadar.weather.humidity!=null && <span>üíß {weatherRadar.weather.humidity}%</span>}
                                                {weatherRadar.weather.wind_speed!=null && <span>üí® {weatherRadar.weather.wind_speed} –∫–º/—á</span>}
                                            </div>
                                        </div>
                                    </div>
                                    {/* Radar frames */}
                                    {weatherRadar.frames?.length > 0 && (
                                        <div className="card" style={{padding:12,marginBottom:12}}>
                                            <div style={{position:'relative',width:'100%',paddingBottom:'100%',background:'rgba(0,0,0,0.4)',borderRadius:8,overflow:'hidden'}}>
                                                <img src={weatherRadar.frames[radarFrame]?.url} alt="Radar" style={{position:'absolute',top:0,left:0,width:'100%',height:'100%',objectFit:'cover',opacity:0.85,transition:'opacity 0.3s'}} onError={e=>{e.target.style.display='none'}}/>
                                                {/* Circuit marker */}
                                                <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',width:10,height:10,borderRadius:'50%',background:'var(--f1-red)',border:'2px solid #fff',boxShadow:'0 0 8px rgba(255,0,0,0.6)',zIndex:2}}/>
                                                {/* Forecast badge */}
                                                {weatherRadar.frames[radarFrame]?.is_forecast && (
                                                    <div style={{position:'absolute',top:8,right:8,background:'rgba(255,255,255,0.15)',backdropFilter:'blur(4px)',borderRadius:6,padding:'2px 8px',fontSize:10,fontWeight:700,color:'#fff'}}>–ü—Ä–æ–≥–Ω–æ–∑</div>
                                                )}
                                            </div>
                                            {/* Timeline */}
                                            <div style={{display:'flex',justifyContent:'space-between',marginTop:8,gap:2}}>
                                                {weatherRadar.frames.map((f,i)=>(
                                                    <div key={i} onClick={()=>setRadarFrame(i)} style={{flex:1,height:3,borderRadius:2,background:i===radarFrame?'var(--f1-red)':f.is_forecast?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.3)',cursor:'pointer',transition:'background 0.2s'}}/>
                                                ))}
                                            </div>
                                            <div style={{display:'flex',justifyContent:'space-between',marginTop:4,fontSize:9,color:'var(--f1-text-muted)'}}>
                                                <span>–ü—Ä–æ—à–ª–æ–µ</span>
                                                <span>–°–µ–π—á–∞—Å</span>
                                                <span>–ü—Ä–æ–≥–Ω–æ–∑</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : <div style={{textAlign:'center',padding:40,color:'var(--f1-text-muted)'}}><div style={{fontSize:48,marginBottom:12}}>üå§Ô∏è</div><div style={{fontSize:15,fontWeight:700}}>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã...</div></div>}
                        </div>
                    )}
                </div>
            );
        };

        // ==== RACE DETAIL PAGE ====
        const RaceDetailPage = ({race, onBack, season, spoilerFree, allRaces}) => {
            const [tyreData, setTyreData] = useState(null);
            const [tyreLoading, setTyreLoading] = useState(false);
            const [revealed, setRevealed] = useState(false);
            useEffect(() => {
                setRevealed(false);
                if (race?.round) {
                    setTyreLoading(true);
                    setTyreData(null);
                    api.get(`/api/race/${race.round}/tyres`).then(d => {
                        if (d?.drivers?.length > 0) setTyreData(d);
                    }).finally(() => setTyreLoading(false));
                }
            }, [race?.round]);

            if (!race) return <div className="page-container fade-in" style={{padding:16}}><CardSkeleton/><div style={{height:12}}/><CardSkeleton/></div>;

            // Determine if this race should be spoiler-hidden
            const now = new Date();
            const lastCompletedRound = allRaces?.filter(r => new Date(r.date) < now).pop();
            const isSpoilerHidden = spoilerFree && !revealed && lastCompletedRound && race.round === lastCompletedRound.round;

            const flag = circuitFlags[race.circuit_id] || 'üèÅ';
            const dateStr = new Date(race.date).toLocaleDateString('ru-RU', {day:'numeric', month:'long', year:'numeric'});
            const podiumColors = ['#FFD700','#C0C0C0','#CD7F32'];
            const podiumHeights = [130, 100, 85];
            const podiumSizes = [64, 48, 48];
            const tyreColors = {SOFT:'#FF3333',MEDIUM:'#FFD700',HARD:'#CCCCCC',INTERMEDIATE:'#39B54A',WET:'#0067FF',UNKNOWN:'#888'};

            return (
                <div className="page-container fade-in" style={{padding:'12px 16px'}}>
                    <button onClick={onBack} style={{background:'none',border:'none',color:'var(--f1-text-muted)',fontSize:13,fontFamily:'inherit',cursor:'pointer',marginBottom:12,display:'flex',alignItems:'center',gap:4}}>‚Üê –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>

                    {/* Race header */}
                    <div className="gradient-card" style={{marginBottom:16,minHeight:120}}>
                        {race.circuit_image && <img src={race.circuit_image} alt="" style={{position:'absolute',top:0,right:0,width:'55%',height:'100%',objectFit:'contain',opacity:0.08,pointerEvents:'none'}}/>}
                        <div style={{position:'absolute',top:0,left:0,right:0,bottom:0,background:'linear-gradient(135deg,rgba(225,6,0,0.15) 0%,transparent 60%)',pointerEvents:'none',borderRadius:16}}/>
                        <div style={{position:'relative',zIndex:1}}>
                            <div style={{display:'flex',alignItems:'center',gap:10}}>
                                <span style={{fontSize:36}}>{flag}</span>
                                <div>
                                    <div style={{fontSize:20,fontWeight:900}}>{race.name}</div>
                                    <div style={{fontSize:13,color:'var(--f1-text-secondary)'}}>{race.circuit_name} ¬∑ –†–∞—É–Ω–¥ {race.round}</div>
                                    <div style={{fontSize:12,color:'var(--f1-text-muted)',marginTop:2}}>{dateStr} ¬∑ {race.laps} –∫—Ä—É–≥–æ–≤</div>
                                </div>
                            </div>
                            {race.sprint && <div style={{marginTop:8,display:'inline-block',background:'rgba(255,128,0,0.2)',color:'#FF8000',fontSize:11,fontWeight:700,padding:'3px 10px',borderRadius:6}}>–°–ø—Ä–∏–Ω—Ç-—É–∏–∫–µ–Ω–¥</div>}
                        </div>
                    </div>

                    {/* Spoiler reveal button */}
                    {isSpoilerHidden && (
                        <div className="card" onClick={()=>setRevealed(true)} style={{padding:'16px 20px',marginBottom:16,cursor:'pointer',textAlign:'center',background:'rgba(225,6,0,0.08)',border:'1px solid rgba(225,6,0,0.2)'}}>
                            <div style={{fontSize:24,marginBottom:6}}>üîí</div>
                            <div style={{fontSize:14,fontWeight:700,color:'var(--f1-red)'}}>–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',marginTop:4}}>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫—Ä—ã—Ç—ã —Ä–µ–∂–∏–º–æ–º –∞–Ω—Ç–∏—Å–ø–æ–π–ª–µ—Ä–∞</div>
                        </div>
                    )}

                    {/* Podium */}
                    {race.podium?.length >= 3 && (
                        <div className="card" style={{padding:'16px 12px', marginBottom:16, position:'relative', overflow:'hidden'}}>
                            <div style={{filter:isSpoilerHidden?'blur(15px)':'none',transition:'filter 0.3s',pointerEvents:isSpoilerHidden?'none':'auto'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:14}}>üèÜ –ü–æ–¥–∏—É–º</div>
                            <div style={{display:'flex',justifyContent:'center',alignItems:'flex-end',gap:8,marginBottom:4}}>
                                {[1,0,2].map(idx => {
                                    const d = race.podium[idx]; if(!d) return null;
                                    return (
                                        <div key={idx} style={{flex:1,maxWidth:110,textAlign:'center'}}>
                                            <div style={{position:'relative',marginBottom:6}}>
                                                {d.photo_url && <img src={d.photo_url} alt="" style={{width:podiumSizes[idx],height:podiumSizes[idx],borderRadius:'50%',objectFit:'cover',border:`3px solid ${podiumColors[idx]}`,background:'var(--f1-gray)',margin:'0 auto'}} onError={e=>{e.target.style.display='none'}} loading="lazy"/>}
                                            </div>
                                            <div style={{fontWeight:900,fontSize:idx===0?16:14}}>{d.code}</div>
                                            <div style={{fontSize:10,color:d.team_color,fontWeight:600}}>{d.team?.split(' ')[0]}</div>
                                            <div style={{background:`${podiumColors[idx]}22`,borderRadius:'8px 8px 0 0',padding:'10px 0',marginTop:6,height:podiumHeights[idx],display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-start',paddingTop:10}}>
                                                <div style={{fontSize:28,fontWeight:900,color:podiumColors[idx]}}>{idx+1}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            </div>{/* close blur wrapper */}
                        </div>
                    )}

                    {/* Full top-10 results */}
                    {race.top_10?.length > 0 && (
                        <div className="card" style={{padding:'16px 12px', marginBottom:16}}>
                            <div style={{filter:isSpoilerHidden?'blur(15px)':'none',transition:'filter 0.3s',pointerEvents:isSpoilerHidden?'none':'auto'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>üìã –¢–æ–ø-10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
                            {race.top_10.map((d, i) => (
                                <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderBottom:i<race.top_10.length-1?'1px solid var(--f1-border)':'none'}}>
                                    <PosBadge pos={d.position}/>
                                    <div style={{background:d.team_color,width:3,height:28,borderRadius:2}}/>
                                    {d.photo_url && <DriverPhoto url={d.photo_url} size={28}/>}
                                    <div style={{flex:1,minWidth:0}}>
                                        <span style={{fontWeight:700,fontSize:13}}>{d.code}</span>
                                        <span style={{fontSize:11,color:'var(--f1-text-muted)',marginLeft:6}}>{d.first_name} {d.last_name}</span>
                                    </div>
                                    <span style={{fontSize:11,color:d.team_color,fontWeight:600}}>{d.team?.split(' ')[0]}</span>
                                </div>
                            ))}
                            </div>{/* close blur wrapper */}
                        </div>
                    )}

                    {/* Sprint top-10 results */}
                    {race.sprint_top_10?.length > 0 && (
                        <div className="card" style={{padding:'16px 12px', marginBottom:16}}>
                            <div style={{filter:isSpoilerHidden?'blur(15px)':'none',transition:'filter 0.3s',pointerEvents:isSpoilerHidden?'none':'auto'}}>
                            <div style={{fontSize:11,color:'#FF8000',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:10}}>üèÅ –°–ø—Ä–∏–Ω—Ç ¬∑ –¢–æ–ø-10</div>
                            {race.sprint_top_10.map((d, i) => (
                                <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderBottom:i<race.sprint_top_10.length-1?'1px solid var(--f1-border)':'none'}}>
                                    <PosBadge pos={d.position}/>
                                    <div style={{background:d.team_color,width:3,height:28,borderRadius:2}}/>
                                    {d.photo_url && <DriverPhoto url={d.photo_url} size={28}/>}
                                    <div style={{flex:1,minWidth:0}}>
                                        <span style={{fontWeight:700,fontSize:13}}>{d.code}</span>
                                        <span style={{fontSize:11,color:'var(--f1-text-muted)',marginLeft:6}}>{d.first_name} {d.last_name}</span>
                                    </div>
                                    <span style={{fontSize:11,color:d.team_color,fontWeight:600}}>{d.team?.split(' ')[0]}</span>
                                </div>
                            ))}
                            </div>{/* close blur wrapper */}
                        </div>
                    )}

                    {/* Tyre Strategy */}
                    {tyreLoading && (
                        <div className="card" style={{padding:'20px 12px', marginBottom:16, textAlign:'center'}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5}}>üèéÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —à–∏–Ω...</div>
                        </div>
                    )}
                    {tyreData && (
                        <div className="card" style={{padding:'16px 12px', marginBottom:16}}>
                            <div style={{fontSize:11,color:'var(--f1-text-muted)',fontWeight:700,textTransform:'uppercase',letterSpacing:1.5,marginBottom:8}}>üèéÔ∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—è —à–∏–Ω ¬∑ {tyreData.total_laps} –∫—Ä—É–≥–æ–≤</div>
                            <div style={{display:'flex',gap:10,marginBottom:12,flexWrap:'wrap'}}>
                                {['SOFT','MEDIUM','HARD','INTERMEDIATE','WET'].map(c=>(
                                    <div key={c} style={{display:'flex',alignItems:'center',gap:4,fontSize:10}}>
                                        <span style={{width:10,height:10,borderRadius:'50%',background:tyreColors[c],display:'inline-block',border:'1px solid rgba(255,255,255,0.15)'}}/>{c[0]+c.slice(1).toLowerCase()}
                                    </div>
                                ))}
                            </div>
                            {tyreData.drivers.map((d,i)=>(
                                <div key={d.driver_number} style={{display:'flex',alignItems:'center',gap:4,marginBottom:2,padding:'3px 0'}}>
                                    <div style={{width:22,fontSize:9,fontWeight:700,color:'var(--f1-text-muted)',textAlign:'right',flexShrink:0}}>P{d.finish_position}</div>
                                    <div style={{width:3,height:20,borderRadius:2,background:d.team_color,flexShrink:0}}/>
                                    <div style={{width:30,fontSize:10,fontWeight:700,color:'var(--f1-text)',textAlign:'left',flexShrink:0}}>{d.code}</div>
                                    <div style={{flex:1,display:'flex',height:20,borderRadius:3,overflow:'hidden',background:'var(--f1-gray)',gap:1}}>
                                        {d.stints.map((s,j)=>{
                                            const w = (((s.lap_end||tyreData.total_laps) - (s.lap_start||1) + 1) / tyreData.total_laps) * 100;
                                            return <div key={j} style={{width:`${w}%`,background:tyreColors[s.compound]||'#888',minWidth:3,display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,fontWeight:700,color:s.compound==='HARD'||s.compound==='MEDIUM'?'#000':'#fff',overflow:'hidden',transition:'width 0.3s ease'}}>{w>12?`L${s.lap_start||1}-${s.lap_end||''}`:''}</div>;
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* VK Video */}
                    {(race.vk_url || race.vk_search_url) && (
                        <button className="btn-primary" onClick={()=>openLink(race.vk_url || race.vk_search_url)} style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
                            {race.vk_url ? 'üì∫ –°–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å—å –≥–æ–Ω–∫–∏' : 'üîç –ù–∞–π—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é –Ω–∞ VK'}
                        </button>
                    )}
                </div>
            );
        };

        // ==== MAIN APP ====
        const App = () => {
            const [tab, setTab] = useState('home');
            const [currentSeason, setCurrentSeason] = useState(2026);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [nextRace, setNextRace] = useState(null);
            const [lastRace, setLastRace] = useState(null);
            const [schedule, setSchedule] = useState(null);
            const [driversStandings, setDriversStandings] = useState(null);
            const [constructorsStandings, setConstructorsStandings] = useState(null);
            const [session, setSession] = useState(null);
            const [positions, setPositions] = useState(null);
            const [timing, setTiming] = useState(null);
            const [weather, setWeather] = useState(null);
            const [raceControl, setRaceControl] = useState(null);
            const [streams, setStreams] = useState(null);
            const [seasonResults, setSeasonResults] = useState(null);
            const [selectedRound, setSelectedRound] = useState(null);
            const [spoilerFree, setSpoilerFree] = useState(() => localStorage.getItem('f1hub_spoiler_free') === 'true');
            const isLive = session?.is_live;
            const toggleSpoiler = () => { const v = !spoilerFree; setSpoilerFree(v); localStorage.setItem('f1hub_spoiler_free', String(v)); };

            useEffect(() => {
                (async () => {
                    const [u, s] = await Promise.all([api.get('/api/user/me'), api.get('/api/live/session')]);
                    setUser(u); setSession(s); setLoading(false);
                })();
            }, []);

            useEffect(() => {
                if (loading) return;
                const s = currentSeason;
                setNextRace(null); setLastRace(null); setDriversStandings(null); setConstructorsStandings(null); setSchedule(null); setSeasonResults(null);
                Promise.all([api.get(`/api/home?season=${s}`),api.get(`/api/standings/drivers?season=${s}`),api.get(`/api/standings/constructors?season=${s}`),api.get(`/api/schedule?season=${s}`),api.get('/api/streams'),api.get(`/api/season/${s}/results`)]).then(([home,ds,cs,sched,str,sr])=>{
                    if(home){setNextRace(home.next_race);setLastRace(home.last_race);}
                    setDriversStandings(ds); setConstructorsStandings(cs); setSchedule(sched); setStreams(str); setSeasonResults(sr);
                });
            }, [loading, currentSeason]);

            useEffect(() => {
                if (tab !== 'live') return;
                const fetchLive = async () => { const d=await api.get('/api/live/dashboard'); if(d){setSession(d.session);setPositions(d.positions);setTiming(d.timing);setWeather(d.weather);setRaceControl(d.race_control);} };
                fetchLive();
                const iv = setInterval(fetchLive, isLive ? 10000 : 30000);
                return () => clearInterval(iv);
            }, [tab, isLive]);

            useEffect(() => {
                if (!tg) return;
                if (tab === 'raceDetail') {
                    tg.BackButton?.show();
                    const h = () => setTab('schedule');
                    tg.BackButton?.onClick(h);
                    return () => tg.BackButton?.offClick(h);
                } else if (tab === 'analytics') {
                    tg.BackButton?.show();
                    const h = () => setTab('live');
                    tg.BackButton?.onClick(h);
                    return () => tg.BackButton?.offClick(h);
                } else if (tab !== 'home') {
                    tg.BackButton?.show();
                    const h = () => setTab('home');
                    tg.BackButton?.onClick(h);
                    return () => tg.BackButton?.offClick(h);
                } else {
                    tg.BackButton?.hide();
                }
            }, [tab]);

            if (loading) return (
                <div style={{height:'100dvh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:16}}>
                    <div style={{fontSize:48}}>üèéÔ∏è</div>
                    <div style={{fontSize:22,fontWeight:900}}>F1 <span style={{color:'var(--f1-red)'}}>Hub</span></div>
                    <div style={{width:40,height:4,borderRadius:2,background:'var(--f1-gray)',overflow:'hidden'}}><div style={{width:'50%',height:'100%',background:'var(--f1-red)',borderRadius:2,animation:'shimmer 1s infinite alternate'}}/></div>
                </div>
            );

            const renderTab = () => {
                switch(tab) {
                    case 'home': return <HomePage nextRace={nextRace} lastRace={lastRace} standings={driversStandings} user={user} streams={streams} seasonResults={seasonResults} onChange={setTab} season={currentSeason} onSeasonChange={setCurrentSeason} spoilerFree={spoilerFree && currentSeason === 2026}/>;
                    case 'live': return <LivePage session={session} positions={positions} timing={timing} weather={weather} raceControl={raceControl} onChange={setTab}/>;
                    case 'news': return <NewsPage/>;
                    case 'schedule': return <SchedulePage seasonResults={seasonResults} schedule={schedule} season={currentSeason} onRaceClick={(round)=>{setSelectedRound(round);setTab('raceDetail');}} spoilerFree={spoilerFree} onToggleSpoiler={toggleSpoiler}/>;
                    case 'raceDetail': return <RaceDetailPage race={seasonResults?.races?.find(r=>r.round===selectedRound)} onBack={()=>setTab('schedule')} season={currentSeason} spoilerFree={spoilerFree && currentSeason === 2026} allRaces={seasonResults?.races}/>;
                    case 'standings': return <StandingsPage driversStandings={driversStandings} constructorsStandings={constructorsStandings} season={currentSeason}/>;
                    case 'predict': return <PredictionsPage user={user}/>;
                    case 'profile': return <ProfilePage user={user}/>;
                    case 'analytics': return <AnalyticsPage/>;
                    default: return null;
                }
            };

            return (<>{renderTab()}<BottomNav active={tab} onChange={setTab} isLive={isLive}/></>);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App/>);
    </script>
</body>
</html>
